# Pipeline Architecture Visual Guide

**PR #871** | **Visual Reference** | **Date:** 2025-12-01

---

## ğŸ¨ Before & After Architecture

### BEFORE: Embedded Migrations (Dev Only)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     GitHub Actions Runner                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚             â”‚             â”‚                                 â”‚
â”‚   Build     â”‚    Test     â”‚         Deploy                  â”‚
â”‚             â”‚             â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚Docker â”‚  â”‚  â”‚ Run   â”‚  â”‚  â”‚ SSH to Server           â”‚  â”‚
â”‚  â”‚ Build â”‚â”€â”€â”¼â”€â–¶â”‚ Tests â”‚â”€â”€â”¼â”€â–¶â”‚                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚ 1. Pull image           â”‚  â”‚
â”‚             â”‚             â”‚  â”‚ 2. Run migrations (SSH) â”‚â—€â”€â”¼â”€â”€â”€ âš ï¸ Problem!
â”‚             â”‚             â”‚  â”‚ 3. Start container      â”‚  â”‚
â”‚             â”‚             â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â””â”€â–¶ If migrations fail,
                                            error is buried in SSH logs
```

**Issues:**
- âš ï¸ Migrations run via SSH (unreliable)
- âš ï¸ Error handling difficult
- âš ï¸ Can't block deployment on migration failure
- âš ï¸ Mixed concerns (deploy + migrate)

---

### AFTER: Decoupled Migrations (All Environments)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        GitHub Actions Runner                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          â”‚          â”‚                 â”‚                              â”‚
â”‚  Build   â”‚   Test   â”‚    Migrate      â”‚         Deploy               â”‚
â”‚          â”‚          â”‚   (NEW JOB)     â”‚                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚Dockerâ”‚ â”‚ â”‚ Run  â”‚ â”‚ â”‚ Connect to  â”‚ â”‚ â”‚ SSH to Server            â”‚â”‚
â”‚ â”‚Build â”‚â”€â”¼â–¶â”‚Tests â”‚â”€â”¼â–¶â”‚ Database    â”‚â”€â”¼â–¶â”‚                          â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚             â”‚ â”‚ â”‚ 1. Pull image (SHA)      â”‚â”‚
â”‚          â”‚          â”‚ â”‚ Run:        â”‚ â”‚ â”‚ 2. Start container       â”‚â”‚
â”‚          â”‚          â”‚ â”‚  - migrate  â”‚ â”‚ â”‚    (no migration step)   â”‚â”‚
â”‚          â”‚          â”‚ â”‚  - tenants  â”‚ â”‚ â”‚                          â”‚â”‚
â”‚          â”‚          â”‚ â”‚  - schemas  â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚          â”‚          â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚               â”‚
â”‚          â”‚          â”‚        â”‚        â”‚              â”‚               â”‚
â”‚          â”‚          â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚          â”‚          â”‚                 â”‚                              â”‚
â”‚          â”‚          â”‚         âœ… Succeeds: Deploy starts            â”‚
â”‚          â”‚          â”‚         âŒ Fails: Deploy BLOCKED              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Benefits:**
- âœ… Migrations in CI environment (reliable)
- âœ… Clear error handling
- âœ… Deployment blocked if migrations fail
- âœ… Separated concerns (migrate â†’ deploy)

---

## ğŸ·ï¸ Image Tagging Flow

### Build Stage (Pushes 2 Tags)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Docker Build & Push                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  Source: git commit abc123def456...                â”‚
â”‚                                                     â”‚
â”‚  Build Docker Image                                â”‚
â”‚         â”‚                                           â”‚
â”‚         â”œâ”€â–¶ Tag 1: registry/image:dev-abc123def    â”‚â—€â”€â”€â”€ For deployment
â”‚         â”‚         (immutable, specific version)    â”‚     (MUST use this)
â”‚         â”‚                                           â”‚
â”‚         â””â”€â–¶ Tag 2: registry/image:dev-latest       â”‚â—€â”€â”€â”€ For cache/dev
â”‚                   (mutable, always moves)          â”‚     (DO NOT deploy)
â”‚                                                     â”‚
â”‚  Push Both Tags to Registry                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Deploy Stage (Uses SHA Tag Only)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Deployment (Server)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  docker pull registry/image:dev-abc123def          â”‚â—€â”€â”€â”€ âœ… Correct!
â”‚                                                     â”‚
â”‚  docker run registry/image:dev-abc123def           â”‚
â”‚                                                     â”‚
â”‚  âŒ NEVER:                                          â”‚
â”‚     docker pull registry/image:dev-latest          â”‚â—€â”€â”€â”€ âš ï¸ Wrong!
â”‚     docker run registry/image:dev-latest           â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Why SHA Tags for Deployment?**
- Know exact version running
- Can rollback to specific SHA
- Immune to "tag moved" issues
- Reproducible deployments

**Why Keep `-latest`?**
- Useful for local development
- Enables layer caching
- Quick "get latest" for testing

---

## ğŸ”„ Migration Job Flow

### Idempotent Migration Pattern

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Migrate Job                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Step 1: Shared Schema        â”‚
         â”‚  migrate_schemas --shared     â”‚
         â”‚     --fake-initial            â”‚â—€â”€â”€â”€â”€â”€â”€ Skips if exists
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Step 2: Super Tenant         â”‚
         â”‚  create_super_tenant          â”‚
         â”‚     --no-input                â”‚â—€â”€â”€â”€â”€â”€â”€ Idempotent
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Step 3: Tenant Schemas       â”‚
         â”‚  migrate_schemas --tenant     â”‚â—€â”€â”€â”€â”€â”€â”€ Per-tenant
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Success? â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â–¶ Deploy Proceeds
              â”‚                  â”‚
              â”‚  Failure? â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â–¶ Deploy BLOCKED
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸŒ Environment Consistency

### All Three Environments Now Identical

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Development    â”‚    â”‚       UAT        â”‚    â”‚   Production     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  â”‚    â”‚                  â”‚    â”‚                  â”‚
â”‚  build-and-push  â”‚    â”‚  build-and-push  â”‚    â”‚  build-and-push  â”‚
â”‚        â”‚         â”‚    â”‚        â”‚         â”‚    â”‚        â”‚         â”‚
â”‚        â–¼         â”‚    â”‚        â–¼         â”‚    â”‚        â–¼         â”‚
â”‚  test-backend    â”‚    â”‚  test-backend    â”‚    â”‚  test-backend    â”‚
â”‚        â”‚         â”‚    â”‚        â”‚         â”‚    â”‚        â”‚         â”‚
â”‚        â–¼         â”‚    â”‚        â–¼         â”‚    â”‚        â–¼         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  migrate   â”‚  â”‚    â”‚  â”‚  migrate   â”‚  â”‚    â”‚  â”‚  migrate   â”‚  â”‚
â”‚  â”‚ (CI env)   â”‚  â”‚    â”‚  â”‚ (CI env)   â”‚  â”‚    â”‚  â”‚ (CI env)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â”‚         â”‚    â”‚        â”‚         â”‚    â”‚        â”‚         â”‚
â”‚        â–¼         â”‚    â”‚        â–¼         â”‚    â”‚        â–¼         â”‚
â”‚      deploy      â”‚    â”‚      deploy      â”‚    â”‚      deploy      â”‚
â”‚                  â”‚    â”‚                  â”‚    â”‚                  â”‚
â”‚  Uses: dev-SHA   â”‚    â”‚  Uses: uat-SHA   â”‚    â”‚  Uses: prod-SHA  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

     âœ… Identical            âœ… Identical            âœ… Identical
     Pattern!               Pattern!               Pattern!
```

---

## ğŸ¯ Decision Tree: When to Use What

### Should I use SHA tag or -latest?

```
                    Start
                      â”‚
                      â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  What are you doing?   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                           â–¼
  Deploying to                Local Dev /
  Server?                     Testing?
        â”‚                           â”‚
        â–¼                           â–¼
  Use SHA Tag              Use -latest OK
  (immutable)              (convenience)
        â”‚                           â”‚
        â–¼                           â–¼
  dev-abc123def            dev-latest
  uat-abc123def            uat-latest
  prod-abc123def           prod-latest
```

### Should migrations run in CI or on server?

```
                    Start
                      â”‚
                      â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Where are you?        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                           â–¼
  GitHub Actions               SSH Session
  Workflow?                    on Server?
        â”‚                           â”‚
        â–¼                           â–¼
  YES - Run here              NO - Don't run
  (migrate job)               (deploy job)
        â”‚                           â”‚
        â–¼                           â–¼
  Controlled                  Only start
  environment                 container
```

---

## ğŸ” Security Flow

### Secret Management

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   GitHub Secrets                            â”‚
â”‚  (Encrypted at rest, never shown in logs)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼               â–¼               â–¼
   Dev Env          UAT Env        Prod Env
   Secrets          Secrets        Secrets
       â”‚               â”‚               â”‚
       â–¼               â–¼               â–¼
 DEV_DB_URL      UAT_DB_URL      PROD_DB_URL
       â”‚               â”‚               â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Migrate Job    â”‚
              â”‚  (uses secrets) â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   Database      â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Never:**
- âŒ Hardcode credentials
- âŒ Pass via environment variables in deployment scripts
- âŒ Store in workflow files

**Always:**
- âœ… Use GitHub Secrets
- âœ… Scope to environment (dev-backend, uat-backend, etc.)
- âœ… Rotate regularly

---

## ğŸ“Š Success Indicators

### How to Know It's Working

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Healthy Pipeline                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  âœ… Migrate job completes < 15 minutes                     â”‚
â”‚  âœ… No "relation already exists" errors                    â”‚
â”‚  âœ… Deploy jobs wait for migrate completion                â”‚
â”‚  âœ… Containers show SHA tag (docker ps)                    â”‚
â”‚  âœ… Rollback works (deploy previous SHA)                   â”‚
â”‚  âœ… Codespace auto-migrates on startup                     â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Problem Indicators                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  âš ï¸ Migrate job timeout (> 15 min)                         â”‚
â”‚  âš ï¸ "Already exists" errors in logs                        â”‚
â”‚  âš ï¸ Deploy starts before migrate completes                 â”‚
â”‚  âš ï¸ Containers show ":latest" tag                          â”‚
â”‚  âš ï¸ Can't identify deployed version                        â”‚
â”‚  âš ï¸ Codespace requires manual migration                    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ Rollback Scenario

### Emergency Rollback Procedure

```
                    Incident Detected!
                           â”‚
                           â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚ Check current SHA     â”‚
               â”‚ docker ps             â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚ Find previous good SHAâ”‚
               â”‚ git log --oneline     â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚ Option A: Revert PR   â”‚
               â”‚ git revert <commit>   â”‚
               â”‚ Push to trigger CI    â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    OR     â”‚
                           â”‚
                           â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚ Option B: Manual      â”‚
               â”‚ SSH to server         â”‚
               â”‚ docker pull old SHA   â”‚
               â”‚ docker run old SHA    â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Verify Fix   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“š Quick Reference Card

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘               PIPELINE QUICK REFERENCE                     â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                            â•‘
â•‘  TAGS:                                                     â•‘
â•‘    Build:  dev-${sha} + dev-latest                        â•‘
â•‘    Deploy: dev-${sha} ONLY                                â•‘
â•‘                                                            â•‘
â•‘  JOBS:                                                     â•‘
â•‘    1. build-and-push                                      â•‘
â•‘    2. test-backend                                        â•‘
â•‘    3. migrate (NEW - runs in CI)                          â•‘
â•‘    4. deploy-backend (waits for migrate)                  â•‘
â•‘                                                            â•‘
â•‘  MIGRATION:                                                â•‘
â•‘    --fake-initial = idempotent                            â•‘
â•‘    Runs BEFORE deployment                                 â•‘
â•‘    Blocks deploy if fails                                 â•‘
â•‘                                                            â•‘
â•‘  ROLLBACK:                                                 â•‘
â•‘    Use previous SHA tag                                   â•‘
â•‘    OR: Revert merge commit                                â•‘
â•‘                                                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

**For detailed documentation, see:**
- `docs/PIPELINE_DECOUPLING_IMPLEMENTATION.md` - Full guide
- `docs/PIPELINE_IMPLEMENTATION_VALIDATION.md` - Testing
- `docs/PIPELINE_CHANGES_QUICK_REF.md` - Quick ref
- `IMPLEMENTATION_COMPLETE.md` - Summary

**PR:** https://github.com/Meats-Central/ProjectMeats/pull/871
