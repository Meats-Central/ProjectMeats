name: Promote Development to UAT
# UAT (uat.meatscentral.com) is the active middle environment per pipeline.
# DEPRECATED: staging.meatscentral.com - use uat.meatscentral.com instead.

on:
  push:
    branches:
      - development
  workflow_dispatch:

concurrency:
  group: promote-${{ github.ref }}
  cancel-in-progress: false

jobs:
  create-uat-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: development

      - name: Check if PR already exists and close it
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          # Check for existing open PR
          PR_NUMBER=$(gh pr list --base uat --head development --state open --json number --jq 'if length > 0 then .[0].number else empty end')
          
          if [ -n "$PR_NUMBER" ]; then
            echo "Found existing PR #${PR_NUMBER}. Closing it to create a new one with latest commits..."
            gh pr close "${PR_NUMBER}" --comment "Closing this PR to create a new one with the latest commits from development branch." --delete-branch=false
            echo "::notice::Closed existing PR #${PR_NUMBER}"
          else
            echo "No existing PR found."
          fi
          
      - name: Create Pull Request to UAT
        id: create-pr
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          PR_URL=$(gh pr create \
            --base uat \
            --head development \
            --title "Promote development to UAT" \
            --body "Auto-created PR to promote tested changes from development to UAT environment. Only merges after CI/test checks and review." \
            --reviewer Vacilator)
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "::notice::Created PR: $PR_URL"

      - name: Add labels to PR
        if: success()
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          PR_NUMBER=$(echo "${{ steps.create-pr.outputs.pr_url }}" | grep -oP '\d+$')
          gh pr edit "$PR_NUMBER" --add-label "auto-promotion,uat-release" || echo "::warning::Could not add labels (they may not exist)"

      - name: Notify on failure
        if: failure()
        run: echo "::warning::PR creation failed"
