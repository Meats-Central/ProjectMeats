name: Validate Tag Name

on:
  push:
    tags:
      - '*'
  workflow_dispatch:

jobs:
  validate-tag-name:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Check tag naming convention
        id: check-tag
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"

          echo "Validating tag name: $TAG_NAME"

          # Define valid tag patterns based on semantic versioning and environment tags
          # Production releases: v1.0.0, v2.1.3, etc.
          SEMVER_PATTERN="^v[0-9]+\.[0-9]+\.[0-9]+$"

          # Pre-release tags: v1.0.0-alpha.1, v1.0.0-beta.2, v1.0.0-rc.1
          PRERELEASE_PATTERN="^v[0-9]+\.[0-9]+\.[0-9]+-(alpha|beta|rc)\.[0-9]+$"

          # Environment tags: v1.0.0-dev, v1.0.0-uat
          ENV_PATTERN="^v[0-9]+\.[0-9]+\.[0-9]+-(dev|uat)$"

          # Legacy/special tags (for backwards compatibility)
          SPECIAL_PATTERN="^(dev|uat|staging|production|release)-[0-9]{4}-[0-9]{2}-[0-9]{2}$"

          if [[ "$TAG_NAME" =~ $SEMVER_PATTERN ]]; then
            echo "✅ Tag follows semantic versioning (production release)"
            echo "tag_type=production" >> $GITHUB_OUTPUT
            echo "valid=true" >> $GITHUB_OUTPUT
          elif [[ "$TAG_NAME" =~ $PRERELEASE_PATTERN ]]; then
            echo "✅ Tag follows semantic versioning (pre-release)"
            echo "tag_type=prerelease" >> $GITHUB_OUTPUT
            echo "valid=true" >> $GITHUB_OUTPUT
          elif [[ "$TAG_NAME" =~ $ENV_PATTERN ]]; then
            echo "✅ Tag follows environment tagging convention"
            echo "tag_type=environment" >> $GITHUB_OUTPUT
            echo "valid=true" >> $GITHUB_OUTPUT
          elif [[ "$TAG_NAME" =~ $SPECIAL_PATTERN ]]; then
            echo "⚠️  Tag follows legacy pattern (consider migrating to semver)"
            echo "tag_type=legacy" >> $GITHUB_OUTPUT
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Invalid tag name: $TAG_NAME"
            echo "valid=false" >> $GITHUB_OUTPUT

            # Create helpful error message
            cat << EOF

            Tag name must follow semantic versioning or environment tagging conventions:

            Production Releases (recommended):
            - Format: vMAJOR.MINOR.PATCH
            - Examples: v1.0.0, v2.3.1, v10.5.2

            Pre-release Tags:
            - Format: vMAJOR.MINOR.PATCH-TYPE.NUMBER
            - Types: alpha, beta, rc (release candidate)
            - Examples: v1.0.0-alpha.1, v2.0.0-beta.3, v3.0.0-rc.1

            Environment Tags:
            - Format: vMAJOR.MINOR.PATCH-ENV
            - Environments: dev, uat
            - Examples: v1.0.0-dev, v2.1.0-uat

            Legacy Format (not recommended):
            - Format: ENV-YYYY-MM-DD
            - Examples: production-2024-01-15, uat-2024-02-20

            Best Practices:
            - Use annotated tags for releases: git tag -a v1.0.0 -m "Release v1.0.0"
            - Follow semantic versioning: https://semver.org/
            - Tag major/minor releases in main branch after stable PR merges
            - Use pre-release tags for testing in UAT

            Examples:
            ✅ v1.0.0 (production release)
            ✅ v2.1.3 (production release)
            ✅ v1.0.0-alpha.1 (alpha pre-release)
            ✅ v2.0.0-beta.2 (beta pre-release)
            ✅ v3.0.0-rc.1 (release candidate)
            ✅ v1.5.0-dev (development environment)
            ✅ v1.5.0-uat (UAT environment)
            ❌ 1.0.0 (missing 'v' prefix)
            ❌ v1.0 (missing patch version)
            ❌ release-1.0.0 (wrong format)
            ❌ v1.0.0-Alpha.1 (use lowercase)

            See: .github/copilot-instructions.md for more details
EOF
            exit 1
          fi

      - name: Create GitHub Release (for production tags)
        if: steps.check-tag.outputs.tag_type == 'production' && success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tagName = context.ref.replace('refs/tags/', '');

            console.log(`Creating release for tag: ${tagName}`);

            try {
              // Check if release already exists
              try {
                await github.rest.repos.getReleaseByTag({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  tag: tagName
                });
                console.log('Release already exists, skipping creation');
                return;
              } catch (error) {
                if (error.status !== 404) throw error;
              }

              // Create release
              await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tagName,
                name: `Release ${tagName}`,
                body: `Production release ${tagName}\n\nSee [CHANGELOG.md](CHANGELOG.md) for details.`,
                draft: false,
                prerelease: false
              });

              console.log(`✅ Created release for ${tagName}`);
            } catch (error) {
              console.log(`ℹ️ Could not create release: ${error.message}`);
            }

      - name: Create GitHub Pre-Release (for pre-release tags)
        if: steps.check-tag.outputs.tag_type == 'prerelease' && success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tagName = context.ref.replace('refs/tags/', '');

            console.log(`Creating pre-release for tag: ${tagName}`);

            try {
              // Check if release already exists
              try {
                await github.rest.repos.getReleaseByTag({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  tag: tagName
                });
                console.log('Pre-release already exists, skipping creation');
                return;
              } catch (error) {
                if (error.status !== 404) throw error;
              }

              // Create pre-release
              await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tagName,
                name: `Pre-release ${tagName}`,
                body: `Pre-release ${tagName} for testing\n\n⚠️ This is a pre-release version and may not be stable.`,
                draft: false,
                prerelease: true
              });

              console.log(`✅ Created pre-release for ${tagName}`);
            } catch (error) {
              console.log(`ℹ️ Could not create pre-release: ${error.message}`);
            }

      - name: Validation Summary
        if: success()
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          echo "✅ Tag validation passed"
          echo "Tag: $TAG_NAME"
          echo "Type: ${{ steps.check-tag.outputs.tag_type }}"
