name: Reusable Deployment Worker

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: "Target environment (development, uat, production)"
      image_tag:
        required: true
        type: string
        description: "Docker image tag to deploy (e.g., sha-abc123)"
      backend_environment:
        required: true
        type: string
        description: "GitHub Environment name for backend (e.g., dev-backend, uat2-backend)"
      frontend_environment:
        required: true
        type: string
        description: "GitHub Environment name for frontend (e.g., dev-frontend, uat2-frontend)"
      api_base_url:
        required: true
        type: string
        description: "API base URL for frontend runtime config (e.g., https://dev.meatscentral.com)"
    secrets:
      FRONTEND_SSH_KEY:
        required: true
      BACKEND_SSH_PASSWORD:
        required: true
      FRONTEND_HOST:
        required: true
      FRONTEND_USER:
        required: true
      BACKEND_HOST:
        required: true
      BACKEND_USER:
        required: true
      BACKEND_IP:
        required: true
      DO_ACCESS_TOKEN:
        required: true

env:
  REGISTRY: registry.digitalocean.com/meatscentral
  FRONTEND_IMAGE: projectmeats-frontend
  BACKEND_IMAGE: projectmeats-backend

jobs:
  # ==========================================
  # Stage 1: Run Migrations
  # ==========================================
  migrate:
    runs-on: ubuntu-latest
    environment: ${{ inputs.backend_environment }}
    steps:
      - name: Run migrations via SSH on deployment server
        env:
          SSHPASS: ${{ secrets.BACKEND_SSH_PASSWORD }}
        run: |
          # Install sshpass for password authentication
          sudo apt-get update -qq
          sudo apt-get install -y sshpass
          
          # Run migrations on the deployment server via SSH
          sshpass -e ssh -o StrictHostKeyChecking=yes \
            ${{ secrets.BACKEND_USER }}@${{ secrets.BACKEND_HOST }} << 'SSH_END'
          set -euo pipefail
          
          echo "=== Running migrations on deployment server ==="
          
          # Navigate to project directory
          cd /home/django/ProjectMeats/backend || {
            echo "Error: Project directory not found"
            exit 1
          }
          
          # Activate virtual environment if it exists
          if [ -f "../venv/bin/activate" ]; then
            source ../venv/bin/activate
          elif [ -f "venv/bin/activate" ]; then
            source venv/bin/activate
          fi
          
          # Run migrations (standard Django, NOT migrate_schemas)
          python manage.py migrate --fake-initial --noinput
          
          echo "✓ Migrations completed successfully"
          SSH_END

  # ==========================================
  # Stage 2: Deploy Backend
  # ==========================================
  deploy-backend:
    needs: [migrate]
    runs-on: ubuntu-latest
    environment: ${{ inputs.backend_environment }}
    steps:
      - name: Deploy backend container
        env:
          SSHPASS: ${{ secrets.BACKEND_SSH_PASSWORD }}
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=yes ${{ secrets.BACKEND_USER }}@${{ secrets.BACKEND_HOST }} << 'SSH'
          set -euo pipefail
          
          REG="${{ env.REGISTRY }}"
          IMG="${{ env.BACKEND_IMAGE }}"
          TAG="${{ inputs.image_tag }}"
          
          # Login to registry
          echo "${{ secrets.DO_ACCESS_TOKEN }}" | docker login registry.digitalocean.com -u "${{ secrets.DO_ACCESS_TOKEN }}" --password-stdin
          
          # Pull image (already built by orchestrator)
          docker pull "$REG/$IMG:$TAG"
          
          # Stop old container
          docker rm -f pm-backend || true
          
          # Start new container
          docker run -d --name pm-backend \
            --restart unless-stopped \
            -p 8000:8000 \
            --env-file /home/django/ProjectMeats/backend/.env \
            -v /home/django/ProjectMeats/media:/app/media \
            -v /home/django/ProjectMeats/staticfiles:/app/staticfiles \
            "$REG/$IMG:$TAG"
          
          # Health check
          MAX_ATTEMPTS=20
          ATTEMPT=1
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/api/v1/health/ || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "✓ Backend health check passed (HTTP $HTTP_CODE)"
              exit 0
            fi
            echo "Health check attempt $ATTEMPT/$MAX_ATTEMPTS (HTTP $HTTP_CODE), retrying..."
            sleep 5
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          echo "✗ Backend health check failed after $MAX_ATTEMPTS attempts"
          docker logs pm-backend --tail 50
          exit 1
          SSH

  # ==========================================
  # Stage 3: Deploy Frontend
  # ==========================================
  deploy-frontend:
    needs: [deploy-backend]
    runs-on: ubuntu-latest
    environment: ${{ inputs.frontend_environment }}
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.FRONTEND_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "${{ secrets.FRONTEND_HOST }}" >> ~/.ssh/known_hosts 2>&1

      - name: Deploy frontend container
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.FRONTEND_USER }}@${{ secrets.FRONTEND_HOST }} << 'SSH'
          set -euo pipefail
          
          REG="${{ env.REGISTRY }}"
          IMG="${{ env.FRONTEND_IMAGE }}"
          TAG="${{ inputs.image_tag }}"
          
          # CRITICAL: Create runtime config on HOST (not in container)
          # This ensures environment-specific URLs even though we're using the same image
          mkdir -p /opt/pm/frontend/env
          cat > /opt/pm/frontend/env/env-config.js << 'ENVJS'
window.ENV = {
  API_BASE_URL: "${{ inputs.api_base_url }}",
  ENVIRONMENT: "${{ inputs.environment }}"
};
ENVJS
          
          echo "✓ Created runtime config for ${{ inputs.environment }}"
          cat /opt/pm/frontend/env/env-config.js
          
          # Login to registry
          echo "${{ secrets.DO_ACCESS_TOKEN }}" | docker login registry.digitalocean.com -u "${{ secrets.DO_ACCESS_TOKEN }}" --password-stdin
          
          # Pull image (already built by orchestrator)
          docker pull "$REG/$IMG:$TAG"
          
          # Stop old container
          docker rm -f pm-frontend || true
          
          # Start new container with runtime config mounted
          docker run -d --name pm-frontend \
            --restart unless-stopped \
            -p 8080:80 \
            --add-host backend:${{ secrets.BACKEND_IP }} \
            -v /opt/pm/frontend/env/env-config.js:/usr/share/nginx/html/env-config.js:ro \
            "$REG/$IMG:$TAG"
          
          echo "✓ Frontend deployed with image $TAG"
          SSH
