name: Reusable Deployment Worker

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: "Target environment (development, uat, production)"
      ref:
        required: true
        type: string
        description: "Git reference to deploy"
      backend_environment:
        required: false
        type: string
        description: "GitHub Environment name for backend (e.g., dev-backend)"
        default: ""
      frontend_environment:
        required: false
        type: string
        description: "GitHub Environment name for frontend (e.g., dev-frontend)"
        default: ""
      image_tag:
        required: false
        type: string
        description: "Docker image tag (optional, for future Build Once Deploy Many pattern)"
        default: ""
      api_base_url:
        required: false
        type: string
        description: "API base URL for frontend (optional, for future Build Once Deploy Many pattern)"
        default: ""
    secrets:
      FRONTEND_SSH_KEY:
        required: true
      BACKEND_SSH_PASSWORD:
        required: true
      FRONTEND_HOST:
        required: true
      FRONTEND_USER:
        required: true
      BACKEND_HOST:
        required: true
      BACKEND_USER:
        required: true
      BACKEND_IP:
        required: true
      DATABASE_URL:
        required: true
      SECRET_KEY:
        required: true
      DJANGO_SETTINGS_MODULE:
        required: true
      DO_ACCESS_TOKEN:
        required: true

env:
  REGISTRY: registry.digitalocean.com/meatscentral
  FRONTEND_IMAGE: projectmeats-frontend
  BACKEND_IMAGE: projectmeats-backend
  GHCR_REGISTRY: ghcr.io/meats-central

jobs:
  # ==========================================
  # Stage 1: Build & Push Images
  # ==========================================
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app: [frontend, backend]
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ matrix.app }}-${{ hashFiles(format('{0}/**', matrix.app)) }}
          restore-keys: |
            ${{ runner.os }}-buildx-${{ matrix.app }}-

      - name: Login to DOCR
        uses: docker/login-action@v3
        with:
          registry: registry.digitalocean.com
          username: ${{ secrets.DO_ACCESS_TOKEN }}
          password: ${{ secrets.DO_ACCESS_TOKEN }}

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push ${{ matrix.app }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.app }}/dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ matrix.app == 'frontend' && env.FRONTEND_IMAGE || env.BACKEND_IMAGE }}:${{ inputs.environment }}-${{ github.sha }}
            ${{ env.REGISTRY }}/${{ matrix.app == 'frontend' && env.FRONTEND_IMAGE || env.BACKEND_IMAGE }}:${{ inputs.environment }}-latest
            ${{ env.GHCR_REGISTRY }}/${{ matrix.app == 'frontend' && env.FRONTEND_IMAGE || env.BACKEND_IMAGE }}:${{ inputs.environment }}-${{ github.sha }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

  # ==========================================
  # Stage 2: Test Backend
  # ==========================================
  test-backend:
    needs: [build-and-push]
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: projectmeats_test
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: 'backend/requirements.txt'

      - name: Install dependencies
        working-directory: backend
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Django tests
        working-directory: backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/projectmeats_test
          DJANGO_SETTINGS_MODULE: projectmeats.settings.test
        run: |
          python manage.py test apps/ --verbosity=2

  # ==========================================
  # Stage 3: Test Frontend
  # ==========================================
  test-frontend:
    needs: [build-and-push]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # Required for vitest/coverage-v8
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run tests
        working-directory: frontend
        run: npm run test:ci

      - name: Type check
        working-directory: frontend
        run: npm run type-check

  # ==========================================
  # Stage 4: Migrate Database (Runner-Based)
  # ==========================================
  migrate:
    needs: [test-backend, build-and-push]
    runs-on: ubuntu-latest
    environment: ${{ inputs.backend_environment }}
    steps:
      - name: Login to DigitalOcean Container Registry
        run: |
          echo "${{ secrets.DO_ACCESS_TOKEN }}" | docker login registry.digitalocean.com -u "${{ secrets.DO_ACCESS_TOKEN }}" --password-stdin
      
      - name: Run migrations in Docker container
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          DJANGO_SETTINGS_MODULE: ${{ secrets.DJANGO_SETTINGS_MODULE }}
        run: |
          set -euo pipefail
          
          TAG="${{ inputs.environment }}-${{ github.sha }}"
          IMAGE="${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:$TAG"
          
          echo "=== Pulling backend image ==="
          docker pull "$IMAGE"
          
          echo "=== Running migrations in ephemeral container ==="
          docker run --rm \
            -e DATABASE_URL="$DATABASE_URL" \
            -e SECRET_KEY="$SECRET_KEY" \
            -e DJANGO_SETTINGS_MODULE="$DJANGO_SETTINGS_MODULE" \
            "$IMAGE" \
            python manage.py migrate --fake-initial --noinput
          
          echo "✓ Migrations completed successfully"

  # ==========================================
  # Stage 5: Deploy Backend
  # ==========================================
  deploy-backend:
    needs: [migrate]
    runs-on: ubuntu-latest
    environment: ${{ inputs.backend_environment }}
    steps:
      - name: Deploy backend container
        env:
          SSHPASS: ${{ secrets.BACKEND_SSH_PASSWORD }}
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ secrets.BACKEND_USER }}@${{ secrets.BACKEND_HOST }} << 'SSH'
          set -euo pipefail
          
          REG="${{ env.REGISTRY }}"
          IMG="${{ env.BACKEND_IMAGE }}"
          TAG="${{ inputs.environment }}-${{ github.sha }}"
          
          # Login to registry
          echo "${{ secrets.DO_ACCESS_TOKEN }}" | docker login registry.digitalocean.com -u "${{ secrets.DO_ACCESS_TOKEN }}" --password-stdin
          
          # Pull new image
          docker pull "$REG/$IMG:$TAG"
          
          # Stop old container
          docker rm -f pm-backend || true
          
          # Start new container
          docker run -d --name pm-backend \
            --restart unless-stopped \
            -p 8000:8000 \
            --env-file /home/django/ProjectMeats/backend/.env \
            -v /home/django/ProjectMeats/media:/app/media \
            -v /home/django/ProjectMeats/staticfiles:/app/staticfiles \
            "$REG/$IMG:$TAG"
          
          # Health check
          MAX_ATTEMPTS=20
          ATTEMPT=1
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/api/v1/health/ || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "✓ Backend health check passed (HTTP $HTTP_CODE)"
              exit 0
            fi
            echo "Health check attempt $ATTEMPT/$MAX_ATTEMPTS (HTTP $HTTP_CODE), retrying..."
            sleep 5
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          echo "✗ Backend health check failed after $MAX_ATTEMPTS attempts"
          docker logs pm-backend --tail 50
          exit 1
          SSH

  # ==========================================
  # Stage 6: Deploy Frontend
  # ==========================================
  deploy-frontend:
    needs: [deploy-backend, test-frontend]
    runs-on: ubuntu-latest
    environment: ${{ inputs.frontend_environment }}
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.FRONTEND_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "${{ secrets.FRONTEND_HOST }}" >> ~/.ssh/known_hosts 2>&1

      - name: Deploy frontend container
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.FRONTEND_USER }}@${{ secrets.FRONTEND_HOST }} << 'SSH'
          set -euo pipefail
          
          REG="${{ env.REGISTRY }}"
          IMG="${{ env.FRONTEND_IMAGE }}"
          TAG="${{ inputs.environment }}-${{ github.sha }}"
          
          # Create runtime config
          mkdir -p /opt/pm/frontend/env
          cat > /opt/pm/frontend/env/env-config.js << 'ENVJS'
          window.ENV = {
            API_BASE_URL: "https://${{ inputs.environment }}.meatscentral.com",
            ENVIRONMENT: "${{ inputs.environment }}"
          };
          ENVJS
          
          # Login to registry
          echo "${{ secrets.DO_ACCESS_TOKEN }}" | docker login registry.digitalocean.com -u "${{ secrets.DO_ACCESS_TOKEN }}" --password-stdin
          
          # Pull new image
          docker pull "$REG/$IMG:$TAG"
          
          # Stop old container
          docker rm -f pm-frontend || true
          
          # Start new container
          docker run -d --name pm-frontend \
            --restart unless-stopped \
            -p 8080:80 \
            --add-host backend:${{ secrets.BACKEND_IP }} \
            -v /opt/pm/frontend/env/env-config.js:/usr/share/nginx/html/env-config.js:ro \
            "$REG/$IMG:$TAG"
          
          # Configure nginx reverse proxy
          if command -v nginx >/dev/null 2>&1; then
            cat > /etc/nginx/conf.d/pm-frontend.conf << 'NGINX'
          server {
              listen 80;
              server_name _;
              
              location ~ ^/(api|admin|static)/ {
                  proxy_pass http://${{ secrets.BACKEND_IP }}:8000;
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
              }
              
              location / {
                  proxy_pass http://127.0.0.1:8080;
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
              }
          }
          NGINX
            nginx -t && systemctl reload nginx
          fi
          
          # Health check
          MAX_ATTEMPTS=20
          ATTEMPT=1
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:80/ || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "✓ Frontend health check passed (HTTP $HTTP_CODE)"
              exit 0
            fi
            echo "Health check attempt $ATTEMPT/$MAX_ATTEMPTS (HTTP $HTTP_CODE), retrying..."
            sleep 5
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          echo "✗ Frontend health check failed after $MAX_ATTEMPTS attempts"
          docker logs pm-frontend --tail 50
          exit 1
          SSH
