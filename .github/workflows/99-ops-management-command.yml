name: üéÆ Ops - Run Management Command

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target Environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - uat
          - prod
      command:
        description: 'Django Command (ONLY the subcommand, e.g., "seed_tenants" NOT "python manage.py ...")'
        required: true
        default: 'check'

# Concurrency: Prevent multiple management commands on same environment
concurrency:
  group: ops-management-${{ inputs.environment }}
  cancel-in-progress: false

jobs:
  execute-command:
    name: Run "${{ inputs.command }}" on ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}-backend
    steps:
      - name: Setup SSH
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

      - name: Set Environment Context
        id: context
        run: |
          if [ "${{ inputs.environment }}" == "prod" ]; then
            echo "HOST=${{ secrets.PRODUCTION_HOST }}" >> $GITHUB_OUTPUT
            echo "USER=${{ secrets.PRODUCTION_USER }}" >> $GITHUB_OUTPUT
            echo "PASS=${{ secrets.SSH_PASSWORD }}" >> $GITHUB_OUTPUT
          elif [ "${{ inputs.environment }}" == "uat" ]; then
            echo "HOST=${{ secrets.STAGING_HOST }}" >> $GITHUB_OUTPUT
            echo "USER=${{ secrets.STAGING_USER }}" >> $GITHUB_OUTPUT
            echo "PASS=${{ secrets.SSH_PASSWORD }}" >> $GITHUB_OUTPUT
          else
            echo "HOST=${{ secrets.DEV_HOST }}" >> $GITHUB_OUTPUT
            echo "USER=${{ secrets.DEV_USER }}" >> $GITHUB_OUTPUT
            echo "PASS=${{ secrets.DEV_SSH_PASSWORD }}" >> $GITHUB_OUTPUT
          fi

      - name: Execute Remote Command
        env:
          SSHPASS: ${{ steps.context.outputs.PASS }}
          # Django standard environment variables (if provided)
          DJANGO_SUPERUSER_USERNAME: ${{ secrets.DJANGO_SUPERUSER_USERNAME }}
          DJANGO_SUPERUSER_EMAIL: ${{ secrets.DJANGO_SUPERUSER_EMAIL }}
          DJANGO_SUPERUSER_PASSWORD: ${{ secrets.DJANGO_SUPERUSER_PASSWORD }}
          # Core Django settings
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          DJANGO_SETTINGS_MODULE: ${{ secrets.DJANGO_SETTINGS_MODULE }}
          # Database configuration
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
        run: |
          HOST="${{ steps.context.outputs.HOST }}"
          USER="${{ steps.context.outputs.USER }}"
          CMD="${{ inputs.command }}"
          
          echo "üöÄ Executing: $CMD"
          echo "üìç Target: $USER@$HOST"
          echo "üåç Environment: ${{ inputs.environment }}-backend"
          
          # SAFETY CHECK: Strip 'python manage.py' if user accidentally included it
          CLEAN_CMD=$(echo "$CMD" | sed 's/^python manage.py //')
          
          if [ "$CMD" != "$CLEAN_CMD" ]; then
            echo "‚ö†Ô∏è  Auto-corrected command input (removed redundant prefix)"
          fi
          
          # Build environment variable injection string for docker exec
          ENV_VARS=""
          
          # Add Django superuser variables if provided (for init_tenant, createsuperuser, etc.)
          if [ -n "$DJANGO_SUPERUSER_USERNAME" ]; then
            ENV_VARS="$ENV_VARS -e DJANGO_SUPERUSER_USERNAME=\"$DJANGO_SUPERUSER_USERNAME\""
          fi
          if [ -n "$DJANGO_SUPERUSER_EMAIL" ]; then
            ENV_VARS="$ENV_VARS -e DJANGO_SUPERUSER_EMAIL=\"$DJANGO_SUPERUSER_EMAIL\""
          fi
          if [ -n "$DJANGO_SUPERUSER_PASSWORD" ]; then
            ENV_VARS="$ENV_VARS -e DJANGO_SUPERUSER_PASSWORD=\"$DJANGO_SUPERUSER_PASSWORD\""
          fi
          
          # Add core Django settings
          if [ -n "$SECRET_KEY" ]; then
            ENV_VARS="$ENV_VARS -e SECRET_KEY=\"$SECRET_KEY\""
          fi
          if [ -n "$DJANGO_SETTINGS_MODULE" ]; then
            ENV_VARS="$ENV_VARS -e DJANGO_SETTINGS_MODULE=\"$DJANGO_SETTINGS_MODULE\""
          fi
          
          # Add database configuration
          if [ -n "$DATABASE_URL" ]; then
            ENV_VARS="$ENV_VARS -e DATABASE_URL=\"$DATABASE_URL\""
          fi
          if [ -n "$DB_NAME" ]; then
            ENV_VARS="$ENV_VARS -e DB_NAME=\"$DB_NAME\""
          fi
          if [ -n "$DB_USER" ]; then
            ENV_VARS="$ENV_VARS -e DB_USER=\"$DB_USER\""
          fi
          if [ -n "$DB_PASSWORD" ]; then
            ENV_VARS="$ENV_VARS -e DB_PASSWORD=\"$DB_PASSWORD\""
          fi
          if [ -n "$DB_HOST" ]; then
            ENV_VARS="$ENV_VARS -e DB_HOST=\"$DB_HOST\""
          fi
          if [ -n "$DB_PORT" ]; then
            ENV_VARS="$ENV_VARS -e DB_PORT=\"$DB_PORT\""
          fi
          
          echo "üì¶ Injecting environment variables into container..."
          
          # Execute command with environment variables
          sshpass -e ssh -o StrictHostKeyChecking=no $USER@$HOST \
          "docker exec $ENV_VARS pm-backend python manage.py $CLEAN_CMD"
