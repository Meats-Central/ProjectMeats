name: Validate Branch Name

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
  workflow_dispatch:

jobs:
  validate-branch-name:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Check branch naming convention
        id: check-branch
        run: |
          BRANCH_NAME="${{ github.head_ref }}"

          # Define valid branch prefixes according to industry best practices
          # and ProjectMeats standards from copilot-instructions.md
          VALID_PREFIXES="feature/|fix/|chore/|refactor/|hotfix/|docs/|test/|perf/|ci/|build/|revert/|copilot/"

          # Protected branches are allowed without prefix validation
          PROTECTED_BRANCHES="^(main|uat|development|master|develop)$"

          echo "Validating branch name: $BRANCH_NAME"

          # Check if it's a protected branch
          if [[ "$BRANCH_NAME" =~ $PROTECTED_BRANCHES ]]; then
            echo "✅ Protected branch - validation skipped"
            echo "valid=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if branch name follows the naming convention
          if [[ "$BRANCH_NAME" =~ ^($VALID_PREFIXES)[a-z0-9-]+$ ]]; then
            echo "✅ Branch name follows naming conventions"
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Invalid branch name: $BRANCH_NAME"
            echo "valid=false" >> $GITHUB_OUTPUT

            # Create helpful error message
            cat << EOF

            Branch name must follow this pattern:
            <type>/<description>

            Valid types:
            - feature/   : New features
            - fix/       : Bug fixes
            - chore/     : Tooling, infrastructure, or CI maintenance
            - refactor/  : Code refactoring
            - hotfix/    : Emergency quick fixes
            - docs/      : Documentation changes
            - test/      : Test-related changes
            - perf/      : Performance improvements
            - ci/        : CI/CD changes
            - build/     : Build system changes
            - revert/    : Revert previous changes
            - copilot/   : GitHub Copilot automated changes

            Description must:
            - Use lowercase letters, numbers, and hyphens only
            - Be concise but descriptive

            Examples:
            ✅ feature/add-customer-portal
            ✅ fix/login-validation-error
            ✅ chore/update-dependencies
            ✅ refactor/payment-service
            ✅ hotfix/security-patch
            ❌ add-customer-portal (missing type prefix)
            ❌ Feature/AddCustomerPortal (should be lowercase)
            ❌ feature/add_customer_portal (use hyphens, not underscores)

            See: .github/copilot-instructions.md for more details
EOF
            exit 1
          fi

      - name: Comment on PR (if invalid)
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branchName = context.payload.pull_request.head.ref;
            const body = `### ❌ Invalid Branch Name

            The branch name \`${branchName}\` does not follow our naming conventions.

            **Required Format:** \`<type>/<description>\`

            **Valid Types:**
            - \`feature/\` - New features
            - \`fix/\` - Bug fixes
            - \`chore/\` - Tooling, infrastructure, or CI maintenance
            - \`refactor/\` - Code refactoring
            - \`hotfix/\` - Emergency quick fixes
            - \`docs/\` - Documentation changes
            - \`test/\` - Test-related changes
            - \`perf/\` - Performance improvements
            - \`ci/\` - CI/CD changes
            - \`build/\` - Build system changes
            - \`revert/\` - Revert previous changes

            **Description Requirements:**
            - Use lowercase letters, numbers, and hyphens only
            - Be concise but descriptive

            **Examples:**
            - ✅ \`feature/add-customer-portal\`
            - ✅ \`fix/login-validation-error\`
            - ✅ \`chore/update-dependencies\`
            - ✅ \`refactor/payment-service\`
            - ✅ \`hotfix/security-patch\`
            - ❌ \`add-customer-portal\` (missing type prefix)
            - ❌ \`Feature/AddCustomerPortal\` (should be lowercase)
            - ❌ \`feature/add_customer_portal\` (use hyphens, not underscores)

            **To Fix:**
            1. Create a new branch with a valid name
            2. Cherry-pick your commits to the new branch
            3. Open a new PR from the new branch

            See [Branch Naming Conventions](.github/copilot-instructions.md#-branch-organization-naming-tagging-and-promotion) for more details.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Validation Summary
        if: success()
        run: |
          echo "✅ Branch name validation passed"
          echo "Branch: ${{ github.head_ref }}"
