name: Validate Immutable Docker Tags

on:
  pull_request:
    paths:
      - '.github/workflows/*deployment*.yml'
      - '.github/workflows/validate-immutable-tags.yml'
  workflow_dispatch:

jobs:
  validate-tags:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Validate immutable tagging in deployment workflows
        run: |
          echo "=== Validating immutable Docker image tagging ==="
          
          FAILED=0
          
          # Check that deployment workflows use SHA-tagged images
          for workflow in .github/workflows/*deployment*.yml; do
            echo "Checking $workflow..."
            
            # Deploy jobs must use ${{ github.sha }} or ${GITHUB_SHA}
            if grep -q "docker pull.*:.*-latest" "$workflow"; then
              echo "❌ ERROR: $workflow uses '-latest' tag in docker pull"
              echo "   Deploy steps must use SHA-tagged images only"
              FAILED=1
            fi
            
            # Build jobs can create multiple tags (SHA + latest for caching)
            # but should include SHA tag
            if ! grep -q '\${{ github.sha }}' "$workflow" && ! grep -q '${GITHUB_SHA' "$workflow"; then
              echo "⚠️  WARNING: $workflow may not use SHA-based tagging"
            fi
          done
          
          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "=== VALIDATION FAILED ==="
            echo "Deploy steps must pull images using SHA tags only."
            echo "Example: \${{ env.REGISTRY }}/\${{ env.BACKEND_IMAGE }}:prod-\${{ github.sha }}"
            echo ""
            echo "Build steps can push both SHA and -latest tags for caching:"
            echo "  - \${{ env.REGISTRY }}/\${{ env.BACKEND_IMAGE }}:prod-\${{ github.sha }}"
            echo "  - \${{ env.REGISTRY }}/\${{ env.BACKEND_IMAGE }}:prod-latest"
            exit 1
          fi
          
          echo "✓ All deployment workflows use immutable tagging"
