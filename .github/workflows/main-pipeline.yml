name: Master Pipeline

on:
  push:
    branches: [development, uat, main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'archived/**'
  pull_request:
    branches: [development, uat, main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - development
          - uat
          - production

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ==========================================
  # Pre-Deployment Validation (Parallel)
  # ==========================================
  
  lint-docs:
    name: Lint Documentation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Run markdownlint
        run: |
          markdownlint '**/*.md' \
            --ignore 'node_modules/**' \
            --ignore 'archived/**' \
            --ignore 'docs/archived/**' \
            --disable MD013 MD033 MD041 \
            || echo "::warning::Markdown lint issues found. See above for details."
  
  check-docker-tags:
    name: Validate Docker Tags
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' && 
      contains(github.event.pull_request.changed_files, '.github/workflows/')
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1
      
      - name: Validate immutable tagging in deployment workflows
        run: |
          echo "=== Validating immutable Docker image tagging ==="
          
          FAILED=0
          
          # Check reusable-deploy.yml for immutable tagging patterns
          echo "Checking reusable-deploy.yml..."
          
          # Deploy jobs must use SHA-tagged images, not -latest
          if grep -q "docker pull.*:.*-latest" .github/workflows/reusable-deploy.yml 2>/dev/null; then
            echo "❌ ERROR: reusable-deploy.yml uses '-latest' tag in docker pull"
            echo "   Deploy steps must use SHA-tagged images only"
            FAILED=1
          fi
          
          # Check main-pipeline.yml for proper tag patterns
          echo "Checking main-pipeline.yml..."
          if ! grep -q '\${{ github.sha }}' .github/workflows/main-pipeline.yml 2>/dev/null; then
            echo "⚠️  WARNING: main-pipeline.yml may not use SHA-based tagging"
          fi
          
          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "=== VALIDATION FAILED ==="
            echo "Deploy steps must pull images using SHA tags only."
            echo "Example: \${{ env.REGISTRY }}/\${{ env.BACKEND_IMAGE }}:prod-\${{ github.sha }}"
            echo ""
            echo "Build steps can push both SHA and -latest tags for caching:"
            echo "  - \${{ env.REGISTRY }}/\${{ env.BACKEND_IMAGE }}:prod-\${{ github.sha }}"
            echo "  - \${{ env.REGISTRY }}/\${{ env.BACKEND_IMAGE }}:prod-latest"
            exit 1
          fi
          
          echo "✓ All deployment workflows use immutable tagging"

  # ==========================================
  # Route to Development
  # ==========================================
  deploy-dev:
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/development') ||
      (github.event_name == 'workflow_dispatch' && inputs.environment == 'development')
    needs: []  # Runs independently for push events
    uses: ./.github/workflows/reusable-deploy.yml
    with:
      environment: 'development'
      ref: ${{ github.ref }}
      image_tag: 'development-${{ github.sha }}'
      backend_environment: 'dev-backend'
      frontend_environment: 'dev-frontend'
      api_base_url: 'https://dev.meatscentral.com'
    secrets:
      FRONTEND_SSH_KEY: ${{ secrets.DEV_FRONTEND_SSH_KEY }}
      BACKEND_SSH_PASSWORD: ${{ secrets.DEV_SSH_PASSWORD }}
      FRONTEND_HOST: ${{ secrets.DEV_FRONTEND_HOST }}
      FRONTEND_USER: ${{ secrets.DEV_FRONTEND_USER }}
      BACKEND_HOST: ${{ secrets.DEV_HOST }}
      BACKEND_USER: ${{ secrets.DEV_USER }}
      BACKEND_IP: ${{ secrets.DEV_BACKEND_IP }}
      DATABASE_URL: ${{ secrets.DEV_DATABASE_URL }}
      DB_HOST: ${{ secrets.DEV_DB_HOST }}
      DB_PORT: ${{ secrets.DEV_DB_PORT }}
      DB_USER: ${{ secrets.DEV_DB_USER }}
      DB_PASSWORD: ${{ secrets.DEV_DB_PASSWORD }}
      DB_NAME: ${{ secrets.DEV_DB_NAME }}
      SECRET_KEY: ${{ secrets.DEV_SECRET_KEY }}
      DJANGO_SETTINGS_MODULE: ${{ secrets.DEV_DJANGO_SETTINGS_MODULE }}
      DO_ACCESS_TOKEN: ${{ secrets.DO_ACCESS_TOKEN }}

  # ==========================================
  # Route to UAT
  # ==========================================
  deploy-uat:
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/uat') ||
      (github.event_name == 'workflow_dispatch' && inputs.environment == 'uat')
    needs: []  # Runs independently for push events
    uses: ./.github/workflows/reusable-deploy.yml
    with:
      environment: 'uat'
      ref: ${{ github.ref }}
      image_tag: 'uat-${{ github.sha }}'
      backend_environment: 'uat2-backend'
      frontend_environment: 'uat2-frontend'
      api_base_url: 'https://uat.meatscentral.com'
    secrets:
      FRONTEND_SSH_KEY: ${{ secrets.UAT_FRONTEND_SSH_KEY }}
      BACKEND_SSH_PASSWORD: ${{ secrets.UAT_SSH_PASSWORD }}
      FRONTEND_HOST: ${{ secrets.UAT_FRONTEND_HOST }}
      FRONTEND_USER: ${{ secrets.UAT_FRONTEND_USER }}
      BACKEND_HOST: ${{ secrets.UAT_HOST }}
      BACKEND_USER: ${{ secrets.UAT_USER }}
      BACKEND_IP: ${{ secrets.UAT_BACKEND_IP }}
      DATABASE_URL: ${{ secrets.UAT_DATABASE_URL }}
      DB_HOST: ${{ secrets.UAT_DB_HOST }}
      DB_PORT: ${{ secrets.UAT_DB_PORT }}
      DB_USER: ${{ secrets.UAT_DB_USER }}
      DB_PASSWORD: ${{ secrets.UAT_DB_PASSWORD }}
      DB_NAME: ${{ secrets.UAT_DB_NAME }}
      SECRET_KEY: ${{ secrets.UAT_SECRET_KEY }}
      DJANGO_SETTINGS_MODULE: ${{ secrets.UAT_DJANGO_SETTINGS_MODULE }}
      DO_ACCESS_TOKEN: ${{ secrets.DO_ACCESS_TOKEN }}

  # ==========================================
  # Route to Production
  # ==========================================
  deploy-prod:
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && inputs.environment == 'production')
    needs: []  # Runs independently for push events
    uses: ./.github/workflows/reusable-deploy.yml
    with:
      environment: 'production'
      ref: ${{ github.ref }}
      image_tag: 'production-${{ github.sha }}'
      backend_environment: 'prod2-backend'
      frontend_environment: 'prod2-frontend'
      api_base_url: 'https://meatscentral.com'
    secrets:
      FRONTEND_SSH_KEY: ${{ secrets.PROD_FRONTEND_SSH_KEY }}
      BACKEND_SSH_PASSWORD: ${{ secrets.PROD_SSH_PASSWORD }}
      FRONTEND_HOST: ${{ secrets.PROD_FRONTEND_HOST }}
      FRONTEND_USER: ${{ secrets.PROD_FRONTEND_USER }}
      BACKEND_HOST: ${{ secrets.PROD_HOST }}
      BACKEND_USER: ${{ secrets.PROD_USER }}
      BACKEND_IP: ${{ secrets.PROD_BACKEND_IP }}
      DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}
      DB_HOST: ${{ secrets.PROD_DB_HOST }}
      DB_PORT: ${{ secrets.PROD_DB_PORT }}
      DB_USER: ${{ secrets.PROD_DB_USER }}
      DB_PASSWORD: ${{ secrets.PROD_DB_PASSWORD }}
      DB_NAME: ${{ secrets.PROD_DB_NAME }}
      SECRET_KEY: ${{ secrets.PROD_SECRET_KEY }}
      DJANGO_SETTINGS_MODULE: ${{ secrets.PROD_DJANGO_SETTINGS_MODULE }}
      DO_ACCESS_TOKEN: ${{ secrets.DO_ACCESS_TOKEN }}
