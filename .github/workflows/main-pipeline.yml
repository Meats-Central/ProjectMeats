name: Master Pipeline

# Dynamic run names for deployments only
run-name: >-
  ${{ 
    github.event_name == 'workflow_dispatch' && format('üïπÔ∏è Manual Deploy: {0}', inputs.environment) || 
    format('üöÄ Deploy: {0}', github.ref_name) 
  }}

on:
  push:
    branches: [development, uat, main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'archived/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - development
          - uat
          - production

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ==========================================
  # Route to Development
  # ==========================================
  deploy-dev:
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/development') ||
      (github.event_name == 'workflow_dispatch' && inputs.environment == 'development')
    needs: []  # Runs independently for push events
    uses: ./.github/workflows/reusable-deploy.yml
    with:
      environment: 'development'
      ref: ${{ github.ref }}
      image_tag: 'development-${{ github.sha }}'
      backend_environment: 'dev-backend'
      frontend_environment: 'dev-frontend'
      api_base_url: 'https://dev.meatscentral.com'
    secrets:
      DO_ACCESS_TOKEN: ${{ secrets.DO_ACCESS_TOKEN }}
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
      SSH_KEY: ${{ secrets.SSH_KEY }}
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
      DJANGO_SETTINGS_MODULE: ${{ secrets.DJANGO_SETTINGS_MODULE }}
      REACT_APP_API_BASE_URL: ${{ secrets.REACT_APP_API_BASE_URL }}
      BACKEND_HOST: ${{ secrets.BACKEND_HOST }}

  # ==========================================
  # Route to UAT
  # ==========================================
  deploy-uat:
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/uat') ||
      (github.event_name == 'workflow_dispatch' && inputs.environment == 'uat')
    needs: []  # Runs independently for push events
    uses: ./.github/workflows/reusable-deploy.yml
    with:
      environment: 'uat'
      ref: ${{ github.ref }}
      image_tag: 'uat-${{ github.sha }}'
      backend_environment: 'uat-backend'
      frontend_environment: 'uat-frontend'
      api_base_url: 'https://uat.meatscentral.com'
    secrets: inherit

  # ==========================================
  # Route to Production
  # ==========================================
  deploy-prod:
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && inputs.environment == 'production')
    needs: []  # Runs independently for push events
    uses: ./.github/workflows/reusable-deploy.yml
    with:
      environment: 'production'
      ref: ${{ github.ref }}
      image_tag: 'production-${{ github.sha }}'
      backend_environment: 'production-backend'
      frontend_environment: 'production-frontend'
      api_base_url: 'https://meatscentral.com'
    secrets: inherit
