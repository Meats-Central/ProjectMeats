name: Auto-Promote Dev to UAT

on:
  workflow_run:
    workflows: ["Deploy Dev (Frontend + Backend via DOCR)"]
    types:
      - completed
    branches:
      - development
  workflow_dispatch:

jobs:
  create-promotion-pr:
    runs-on: ubuntu-latest
    # Only run if the deployment workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: development

      - name: Check if PR already exists
        id: check-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_COUNT=$(gh pr list --base uat --head development --state open --json number --jq 'length')
          echo "pr_count=$PR_COUNT" >> $GITHUB_OUTPUT
          
      - name: Create Pull Request
        if: steps.check-pr.outputs.pr_count == '0'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr create \
            --base uat \
            --head development \
            --title "üöÄ Auto-Promote: Development ‚Üí UAT" \
            --body "## Automated Promotion from Development to UAT

          This PR was automatically created after successful deployment to the development environment.

          ### ‚úÖ Deployment Status
          - **Source Branch:** development
          - **Target Branch:** uat  
          - **Deployment Workflow:** Completed successfully
          - **Triggered By:** Deploy Dev workflow completion

          ### üîç What This PR Does
          Promotes tested changes from development to UAT for stakeholder review and testing.

          ### ‚öôÔ∏è CI/CD Gates
          This PR must pass the following gates before merge:
          - [ ] UAT deployment workflow (12-uat-deployment.yml) builds successfully
          - [ ] Frontend tests pass
          - [ ] Backend tests pass
          - [ ] Code quality checks pass
          - [ ] Required reviewers approve

          ### üìã Pre-Merge Checklist
          - [ ] Review all changes since last UAT promotion
          - [ ] Verify no breaking changes
          - [ ] Ensure database migrations are backward compatible
          - [ ] Check for security vulnerabilities
          - [ ] Confirm all tests pass in CI

          ### üß™ Testing on UAT
          After merge, verify:
          - [ ] Application deploys successfully to UAT
          - [ ] All features work as expected
          - [ ] No regressions in existing functionality
          - [ ] Performance is acceptable

          ### üìù Notes
          - This PR requires manual review and approval
          - All CI checks must pass before merge
          - UAT deployment will occur automatically after merge

          ---
          **Auto-generated by:** \`.github/workflows/41-auto-promote-dev-to-uat.yml\`
          **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}" \
            --label "auto-promotion,development‚Üíuat"

      - name: PR Already Exists
        if: steps.check-pr.outputs.pr_count != '0'
        run: |
          echo "::notice::An open PR from development to uat already exists. Skipping PR creation."
