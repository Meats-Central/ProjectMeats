name: ü§ñ Auto-Draft Release PR

# Dynamic name showing exactly what is being promoted
run-name: "üìã Draft Promotion: ${{ github.event.workflow_run.head_branch }} ‚Üí ${{ github.event.workflow_run.head_branch == 'development' && 'UAT' || 'Production' }}"

on:
  push:  # Must be explicit so status-check job can run
    branches: ['**']
  workflow_run:
    workflows: ["Master Pipeline"]
    types:
      - completed
    branches:
      - development
      - uat

jobs:
  draft-uat-pr:
    runs-on: ubuntu-latest
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'development' &&
      github.event.workflow_run.event == 'push'
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch all branches
        run: git fetch --all

      - name: Close Existing PR (Force Fresh Release)
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          echo "üîç Checking for existing PR: development -> uat"
          
          EXISTING_PR=$(gh pr list --base uat --head development --state open --json number,url --jq '.[0]')
          
          if [ -n "$EXISTING_PR" ]; then
            PR_NUMBER=$(echo "$EXISTING_PR" | jq -r '.number')
            PR_URL=$(echo "$EXISTING_PR" | jq -r '.url')
            
            echo "üóëÔ∏è  Found existing PR #$PR_NUMBER: $PR_URL"
            echo "üîÑ Closing to create fresh PR with latest changes..."
            
            gh pr close "$PR_NUMBER" --comment "üîÑ Auto-closing to create fresh release PR with all accumulated changes from development."
            
            echo "‚úÖ Closed PR #$PR_NUMBER"
          else
            echo "‚úÖ No existing PR found - will create new one"
          fi

      - name: Check for conflicts and create resolution branch if needed
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          echo "üîç Checking if there are commits to promote..."
          
          # Check if there are any commits to promote
          COMMIT_COUNT=$(git rev-list --count origin/uat..origin/development)
          
          if [ "$COMMIT_COUNT" -eq 0 ]; then
            echo "‚úÖ UAT is already up to date with development (no commits to promote)"
            echo "HAS_CONFLICTS=false" >> $GITHUB_ENV
            echo "NO_COMMITS=true" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "üìä Found $COMMIT_COUNT commits to promote"
          echo "NO_COMMITS=false" >> $GITHUB_ENV
          
          echo "üîç Checking for merge conflicts between development and uat..."
          
          # Try to detect conflicts
          git checkout development
          git checkout -b test-merge-uat
          
          if git merge origin/uat --no-commit --no-ff 2>&1 | grep -q "CONFLICT"; then
            echo "‚ö†Ô∏è  Conflicts detected! Creating auto-resolution branch..."
            git merge --abort
            
            # Create resolution branch
            TIMESTAMP=$(date +%s)
            RESOLUTION_BRANCH="auto-resolve-uat-${TIMESTAMP}"
            git checkout -b "$RESOLUTION_BRANCH"
            
            # Merge with conflict resolution (keep development version)
            git merge origin/uat --no-edit -X ours || {
              echo "Manual merge needed - keeping development version"
              git checkout --ours .
              git add .
              git commit -m "Auto-resolve conflicts (keep development version)"
            }
            
            git push origin "$RESOLUTION_BRANCH"
            
            echo "‚úÖ Created resolution branch: $RESOLUTION_BRANCH"
            echo "RESOLUTION_BRANCH=$RESOLUTION_BRANCH" >> $GITHUB_ENV
            echo "HAS_CONFLICTS=true" >> $GITHUB_ENV
          else
            echo "‚úÖ No conflicts detected"
            # Abort merge only if there's actually a merge in progress
            if [ -f .git/MERGE_HEAD ]; then
              git merge --abort
            fi
            echo "HAS_CONFLICTS=false" >> $GITHUB_ENV
          fi
          
          git checkout development

      - name: Create Fresh Pull Request to UAT
        if: env.NO_COMMITS != 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          if [ "$HAS_CONFLICTS" = "true" ]; then
            echo "üöÄ Creating PR with conflict resolution: $RESOLUTION_BRANCH -> uat"
            HEAD_BRANCH="$RESOLUTION_BRANCH"
          else
            echo "üöÄ Creating fresh PR: development -> uat"
            HEAD_BRANCH="development"
          fi
          
          COMMIT_COUNT=$(git rev-list --count origin/uat..origin/$HEAD_BRANCH)
          RECENT_COMMITS=$(git log origin/uat..origin/$HEAD_BRANCH --oneline --max-count=10)
          
          cat > /tmp/pr-body.md <<'PRBODY'
          ## üöÄ Automated Release PR: Development ‚Üí UAT
          
          **Triggered by:** Successful deployment to Development
          
          ### Review Checklist
          - [ ] Review all changes since last UAT deployment
          - [ ] Verify dev environment is stable
          - [ ] Check for any breaking changes
          - [ ] Confirm all tests passed in development
          
PRBODY
          
          if [ "$HAS_CONFLICTS" = "true" ]; then
            cat >> /tmp/pr-body.md <<'CONFLICT'
          
          ### ‚ö†Ô∏è Conflicts Auto-Resolved
          
          This PR uses an auto-resolution branch because conflicts were detected.
          **Resolution strategy**: Kept development version (ours) for all conflicts.
          
          **Branch**: `$RESOLUTION_BRANCH`
          
          Please review the conflict resolution before merging.
          
CONFLICT
          fi
          
          cat >> /tmp/pr-body.md <<'PRBODY'
          
          **Note:** This is a fresh PR containing all accumulated changes. Previous PR was auto-closed to ensure this is the single source of truth.
          
          ---
          _This PR was automatically created after successful development deployment._
PRBODY
          
          echo "" >> /tmp/pr-body.md
          echo "**Commits included:** $COMMIT_COUNT commits" >> /tmp/pr-body.md
          echo "" >> /tmp/pr-body.md
          echo "### Recent Changes" >> /tmp/pr-body.md
          echo '```' >> /tmp/pr-body.md
          echo "$RECENT_COMMITS" >> /tmp/pr-body.md
          echo '```' >> /tmp/pr-body.md
          
          # Create PR
          PR_URL=$(gh pr create \
            --base uat \
            --head "$HEAD_BRANCH" \
            --title "üöÄ Release: Promote Development to UAT ($(date +%Y-%m-%d))" \
            --body-file /tmp/pr-body.md) || {
            echo "‚ö†Ô∏è  PR creation failed"
            exit 1
          }
          
          echo "‚úÖ PR created: $PR_URL"
          
          # Add labels
          PR_NUMBER=$(echo "$PR_URL" | grep -oP '\d+$')
          if [ "$HAS_CONFLICTS" = "true" ]; then
            gh pr edit "$PR_NUMBER" --add-label "release,automated,auto-resolved" || echo "‚ö†Ô∏è  Could not add labels"
          else
            gh pr edit "$PR_NUMBER" --add-label "release,automated" || echo "‚ö†Ô∏è  Could not add labels"
          fi

  draft-production-pr:
    runs-on: ubuntu-latest
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'uat' &&
      github.event.workflow_run.event == 'push'
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch all branches
        run: git fetch --all

      - name: Close Existing PR (Force Fresh Release)
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          echo "üîç Checking for existing PR: uat -> main"
          
          EXISTING_PR=$(gh pr list --base main --head uat --state open --json number,url --jq '.[0]')
          
          if [ -n "$EXISTING_PR" ]; then
            PR_NUMBER=$(echo "$EXISTING_PR" | jq -r '.number')
            PR_URL=$(echo "$EXISTING_PR" | jq -r '.url')
            
            echo "üóëÔ∏è  Found existing PR #$PR_NUMBER: $PR_URL"
            echo "üîÑ Closing to create fresh PR with latest changes..."
            
            gh pr close "$PR_NUMBER" --comment "üîÑ Auto-closing to create fresh release PR with all accumulated changes from UAT."
            
            echo "‚úÖ Closed PR #$PR_NUMBER"
          else
            echo "‚úÖ No existing PR found - will create new one"
          fi

      - name: Check for conflicts and create resolution branch if needed
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          echo "üîç Checking if there are commits to promote..."
          
          # Check if there are any commits to promote
          COMMIT_COUNT=$(git rev-list --count origin/main..origin/uat)
          
          if [ "$COMMIT_COUNT" -eq 0 ]; then
            echo "‚úÖ Production is already up to date with UAT (no commits to promote)"
            echo "HAS_CONFLICTS=false" >> $GITHUB_ENV
            echo "NO_COMMITS=true" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "üìä Found $COMMIT_COUNT commits to promote"
          echo "NO_COMMITS=false" >> $GITHUB_ENV
          
          echo "üîç Checking for merge conflicts between uat and main..."
          
          # Try to detect conflicts
          git checkout uat
          git checkout -b test-merge-main
          
          if git merge origin/main --no-commit --no-ff 2>&1 | grep -q "CONFLICT"; then
            echo "‚ö†Ô∏è  Conflicts detected! Creating auto-resolution branch..."
            git merge --abort
            
            # Create resolution branch
            TIMESTAMP=$(date +%s)
            RESOLUTION_BRANCH="auto-resolve-prod-${TIMESTAMP}"
            git checkout -b "$RESOLUTION_BRANCH"
            
            # Merge with conflict resolution (keep uat version)
            git merge origin/main --no-edit -X ours || {
              echo "Manual merge needed - keeping uat version"
              git checkout --ours .
              git add .
              git commit -m "Auto-resolve conflicts (keep uat version)"
            }
            
            git push origin "$RESOLUTION_BRANCH"
            
            echo "‚úÖ Created resolution branch: $RESOLUTION_BRANCH"
            echo "RESOLUTION_BRANCH=$RESOLUTION_BRANCH" >> $GITHUB_ENV
            echo "HAS_CONFLICTS=true" >> $GITHUB_ENV
          else
            echo "‚úÖ No conflicts detected"
            # Abort merge only if there's actually a merge in progress
            if [ -f .git/MERGE_HEAD ]; then
              git merge --abort
            fi
            echo "HAS_CONFLICTS=false" >> $GITHUB_ENV
          fi
          
          git checkout uat

      - name: Create Fresh Pull Request to Production
        if: env.NO_COMMITS != 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          if [ "$HAS_CONFLICTS" = "true" ]; then
            echo "üöÄ Creating PR with conflict resolution: $RESOLUTION_BRANCH -> main"
            HEAD_BRANCH="$RESOLUTION_BRANCH"
          else
            echo "üöÄ Creating fresh PR: uat -> main"
            HEAD_BRANCH="uat"
          fi
          
          COMMIT_COUNT=$(git rev-list --count origin/main..origin/$HEAD_BRANCH)
          RECENT_COMMITS=$(git log origin/main..origin/$HEAD_BRANCH --oneline --max-count=10)
          
          cat > /tmp/pr-body.md <<'PRBODY'
          ## üöÄ Automated Release PR: UAT ‚Üí Production
          
          **Triggered by:** Successful deployment to UAT
          
          ### Production Release Checklist
          - [ ] UAT environment verified and stable
          - [ ] All acceptance tests passed
          - [ ] Stakeholder sign-off obtained
          - [ ] Rollback plan confirmed
          - [ ] On-call engineer notified
          
          **‚ö†Ô∏è PRODUCTION DEPLOYMENT** - Requires additional approval
          
PRBODY
          
          if [ "$HAS_CONFLICTS" = "true" ]; then
            cat >> /tmp/pr-body.md <<'CONFLICT'
          
          ### ‚ö†Ô∏è Conflicts Auto-Resolved
          
          This PR uses an auto-resolution branch because conflicts were detected.
          **Resolution strategy**: Kept UAT version (ours) for all conflicts.
          
          **Branch**: `$RESOLUTION_BRANCH`
          
          Please review the conflict resolution before merging to production.
          
CONFLICT
          fi
          
          cat >> /tmp/pr-body.md <<'PRBODY'
          
          **Note:** This is a fresh PR containing all accumulated changes. Previous PR was auto-closed to ensure this is the single source of truth.
          
          ---
          _This PR was automatically created after successful UAT deployment._
PRBODY
          
          echo "" >> /tmp/pr-body.md
          echo "**Commits included:** $COMMIT_COUNT commits" >> /tmp/pr-body.md
          echo "" >> /tmp/pr-body.md
          echo "### Recent Changes" >> /tmp/pr-body.md
          echo '```' >> /tmp/pr-body.md
          echo "$RECENT_COMMITS" >> /tmp/pr-body.md
          echo '```' >> /tmp/pr-body.md
          
          # Create PR
          PR_URL=$(gh pr create \
            --base main \
            --head "$HEAD_BRANCH" \
            --title "üöÄ Release: Promote UAT to Production ($(date +%Y-%m-%d))" \
            --body-file /tmp/pr-body.md) || {
            echo "‚ö†Ô∏è  PR creation failed"
            exit 1
          }
          
          echo "‚úÖ PR created: $PR_URL"
          
          # Add labels
          PR_NUMBER=$(echo "$PR_URL" | grep -oP '\d+$')
          if [ "$HAS_CONFLICTS" = "true" ]; then
            gh pr edit "$PR_NUMBER" --add-label "release,automated,production,auto-resolved" || echo "‚ö†Ô∏è  Could not add labels"
          else
            gh pr edit "$PR_NUMBER" --add-label "release,automated,production" || echo "‚ö†Ô∏è  Could not add labels"
          fi

  status-check:
    runs-on: ubuntu-latest
    # This job always runs to prevent "0 jobs = FAILURE" status
    # It runs on ANY trigger event (push, workflow_run, schedule, workflow_dispatch)
    steps:
      - name: Validate Workflow Trigger
        run: |
          echo "‚úÖ Workflow triggered successfully"
          echo "Event: ${{ github.event_name }}"
          echo "This job prevents false-positive failures when main jobs skip"
