name: Workflow Health Monitor

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  actions: read
  contents: read

jobs:
  monitor-workflow-health:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Check recent workflow failures
        id: check-failures
        run: |
          echo "Checking recent workflow failures..."
          
          # Get failed workflow runs from last 24 hours
          gh api \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/actions/runs \
            --jq '.workflow_runs[] | select(.conclusion == "failure" and (.created_at | fromdateiso8601) > (now - 86400)) | {name: .name, conclusion: .conclusion, created_at: .created_at}' \
            > failures.json || echo "[]" > failures.json
          
          FAILURE_COUNT=$(cat failures.json | wc -l)
          echo "failure_count=$FAILURE_COUNT" >> $GITHUB_OUTPUT
          
          if [[ $FAILURE_COUNT -gt 5 ]]; then
            echo "::warning::High failure rate detected: $FAILURE_COUNT failures in last 24 hours"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Check deployment durations
        id: check-duration
        run: |
          echo "Checking deployment durations..."
          
          # Get recent deployment runs
          gh api \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/actions/runs \
            --jq '.workflow_runs[] | select(.name | contains("Deploy")) | {name: .name, duration: (.updated_at | fromdateiso8601) - (.created_at | fromdateiso8601)}' \
            > durations.json || echo "[]" > durations.json
          
          # Check if any deployment took longer than 15 minutes (900 seconds)
          SLOW_DEPLOYS=$(cat durations.json | jq 'select(.duration > 900)' | wc -l)
          
          if [[ $SLOW_DEPLOYS -gt 0 ]]; then
            echo "::warning::$SLOW_DEPLOYS deployments exceeded 15 minutes"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Check cache effectiveness
        run: |
          echo "Checking Docker cache effectiveness..."
          
          # This would require parsing workflow logs
          # For now, just report that monitoring is active
          echo "âœ“ Cache monitoring active (detailed metrics require log parsing)"
      
      - name: Validate workflow configurations
        run: |
          chmod +x .github/scripts/validate-workflows.sh
          .github/scripts/validate-workflows.sh || echo "::warning::Workflow validation found issues"
      
      - name: Check disk usage on runners
        run: |
          echo "Checking available disk space..."
          df -h
          
          USAGE=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
          if [[ $USAGE -gt 80 ]]; then
            echo "::warning::Disk usage is high: ${USAGE}%"
          fi
      
      - name: Generate health report
        if: always()
        run: |
          cat << EOF > workflow-health-report.md
          # Workflow Health Report
          
          **Generated**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ## Summary
          
          - **Recent Failures**: ${{ steps.check-failures.outputs.failure_count }}
          - **Slow Deployments**: Check logs for details
          - **Disk Usage**: $(df / | awk 'NR==2 {print $5}')
          
          ## Recommendations
          
          - Monitor build cache hit rates
          - Review failed workflow logs
          - Consider cleanup of old workflow runs
          
          ## Next Check
          
          Scheduled for: $(date -u -d '+6 hours' +"%Y-%m-%d %H:%M:%S UTC")
          EOF
          
          cat workflow-health-report.md
      
      - name: Upload health report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: workflow-health-report
          path: workflow-health-report.md
          retention-days: 30
