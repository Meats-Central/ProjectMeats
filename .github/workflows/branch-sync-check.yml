name: ðŸ”„ Branch Sync Monitor

# Monitor and maintain branch synchronization
run-name: "ðŸ” Sync Check: ${{ github.event_name == 'schedule' && 'Daily' || 'Manual' }}"

on:
  push:  # Must be explicit so status-check job can run
    branches: ['**']
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force create sync PRs even if no drift'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  check-dev-to-uat-sync:
    name: Check Development â†’ UAT Sync
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Fetch all branches
        run: git fetch --all
      
      - name: Check for drift
        id: check_drift
        run: |
          echo "ðŸ” Checking if UAT is behind Development..."
          
          # Count commits in development not in uat
          COMMITS_BEHIND=$(git rev-list --count origin/uat..origin/development)
          
          # Check file differences
          FILE_DIFF=$(git diff --stat origin/development..origin/uat | wc -l)
          
          echo "commits_behind=$COMMITS_BEHIND" >> $GITHUB_OUTPUT
          echo "file_diff=$FILE_DIFF" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š UAT Status:"
          echo "  - Commits behind: $COMMITS_BEHIND"
          echo "  - File differences: $FILE_DIFF lines"
          
          if [ "$COMMITS_BEHIND" -gt 0 ] || [ "$FILE_DIFF" -gt 0 ]; then
            echo "âš ï¸  UAT is out of sync with development"
            echo "needs_sync=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… UAT is in sync with development"
            echo "needs_sync=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create sync PR if needed
        if: steps.check_drift.outputs.needs_sync == 'true' || inputs.force_sync
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          echo "ðŸ“‹ Creating sync PR: development â†’ uat"
          
          # Check if PR already exists
          EXISTING_PR=$(gh pr list --base uat --head development --state open --json number --jq '.[0].number')
          
          if [ -n "$EXISTING_PR" ]; then
            echo "âœ… Sync PR already exists: #$EXISTING_PR"
            echo "No action needed - existing PR will handle sync"
            exit 0
          fi
          
          # Create sync PR
          COMMITS=${{ steps.check_drift.outputs.commits_behind }}
          
          cat > /tmp/sync-pr-body.md <<'PRBODY'
          ## ðŸ”„ Branch Sync: Development â†’ UAT
          
          **Triggered by:** Daily sync monitor
          
          ### Why This PR Exists
          
          This PR was automatically created because UAT branch has drifted from development.
          Regular sync prevents merge conflicts and ensures environments stay aligned.
          
          ### Sync Status
          
PRBODY
          
          echo "- **Commits to sync:** $COMMITS" >> /tmp/sync-pr-body.md
          echo "- **File differences:** ${{ steps.check_drift.outputs.file_diff }} lines" >> /tmp/sync-pr-body.md
          echo "" >> /tmp/sync-pr-body.md
          
          cat >> /tmp/sync-pr-body.md <<'PRBODY'
          
          ### Review Checklist
          
          - [ ] Review changes since last sync
          - [ ] Verify no breaking changes
          - [ ] Check for conflicts
          
          ---
          _This PR was automatically created by the branch sync monitor._
PRBODY
          
          gh pr create \
            --base uat \
            --head development \
            --title "ðŸ”„ Sync: Development â†’ UAT ($(date +%Y-%m-%d))" \
            --body-file /tmp/sync-pr-body.md \
            --label "sync,automated" || echo "âš ï¸  PR creation failed"
  
  check-uat-to-prod-sync:
    name: Check UAT â†’ Production Sync
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Fetch all branches
        run: git fetch --all
      
      - name: Check for drift
        id: check_drift
        run: |
          echo "ðŸ” Checking if Production is behind UAT..."
          
          # Count commits in uat not in main
          COMMITS_BEHIND=$(git rev-list --count origin/main..origin/uat)
          
          # Check file differences
          FILE_DIFF=$(git diff --stat origin/uat..origin/main | wc -l)
          
          echo "commits_behind=$COMMITS_BEHIND" >> $GITHUB_OUTPUT
          echo "file_diff=$FILE_DIFF" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š Production Status:"
          echo "  - Commits behind: $COMMITS_BEHIND"
          echo "  - File differences: $FILE_DIFF lines"
          
          if [ "$COMMITS_BEHIND" -gt 0 ] || [ "$FILE_DIFF" -gt 0 ]; then
            echo "âš ï¸  Production is out of sync with UAT"
            echo "needs_sync=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Production is in sync with UAT"
            echo "needs_sync=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Report production drift (informational)
        if: steps.check_drift.outputs.needs_sync == 'true'
        run: |
          echo "ðŸ“Š Production Sync Report"
          echo "========================="
          echo ""
          echo "Production is ${{ steps.check_drift.outputs.commits_behind }} commits behind UAT"
          echo "File differences: ${{ steps.check_drift.outputs.file_diff }} lines"
          echo ""
          echo "â„¹ï¸  Production sync PRs are only created after successful UAT deployments"
          echo "This is informational only - no automatic PR created for production"
          echo ""
          echo "To sync production:"
          echo "1. Wait for UAT deployment to complete"
          echo "2. Auto-PR workflow will create production promotion PR"
          echo "3. Review and merge production PR manually"
  
  summary:
    name: Sync Status Summary
    runs-on: ubuntu-latest
    needs: [check-dev-to-uat-sync, check-uat-to-prod-sync]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ”„ Branch Sync Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Sync Checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Development â†’ UAT: ${{ needs.check-dev-to-uat-sync.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- UAT â†’ Production: ${{ needs.check-uat-to-prod-sync.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Next check: $(date -u -d '+1 day' +"%Y-%m-%d") 00:00 UTC_" >> $GITHUB_STEP_SUMMARY

  status-check:
    runs-on: ubuntu-latest
    # This job always runs to prevent "0 jobs = FAILURE" status
    # It runs on ANY trigger event (push, schedule, workflow_dispatch)
    steps:
      - name: Validate Workflow Trigger
        run: |
          echo "âœ… Workflow triggered successfully"
          echo "Event: ${{ github.event_name }}"
          echo "This job prevents false-positive failures when main jobs skip"
