name: Auto-Promote UAT to Main

on:
  workflow_run:
    workflows: ["Deploy UAT (Frontend + Backend via DOCR)"]
    types:
      - completed
    branches:
      - uat
  workflow_dispatch:

jobs:
  create-promotion-pr:
    runs-on: ubuntu-latest
    # Only run if the deployment workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: uat

      - name: Check if PR already exists
        id: check-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_COUNT=$(gh pr list --base main --head uat --state open --json number --jq 'length')
          echo "pr_count=$PR_COUNT" >> $GITHUB_OUTPUT
          
      - name: Create Pull Request
        if: steps.check-pr.outputs.pr_count == '0'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr create \
            --base main \
            --head uat \
            --title "üöÄ Auto-Promote: UAT ‚Üí Production" \
            --body "## Automated Promotion from UAT to Production

          This PR was automatically created after successful deployment to the UAT environment.

          ### ‚úÖ Deployment Status
          - **Source Branch:** uat
          - **Target Branch:** main (production)
          - **Deployment Workflow:** Completed successfully
          - **Triggered By:** Deploy UAT workflow completion

          ### üîç What This PR Does
          Promotes validated changes from UAT to production after stakeholder approval and testing.

          ### ‚öôÔ∏è CI/CD Gates
          This PR must pass the following gates before merge:
          - [ ] Production deployment workflow (13-prod-deployment.yml) builds successfully
          - [ ] Frontend tests pass
          - [ ] Backend tests pass
          - [ ] Code quality checks pass
          - [ ] Security scans pass
          - [ ] Required reviewers approve
          - [ ] Manual deployment approval (production environment protection)

          ### üìã Pre-Merge Checklist
          - [ ] UAT testing completed successfully
          - [ ] Stakeholder approval obtained
          - [ ] Review all changes since last production release
          - [ ] Verify no breaking changes
          - [ ] Database migrations tested and backward compatible
          - [ ] Security review completed
          - [ ] Performance testing passed
          - [ ] Rollback plan documented
          - [ ] Monitoring and alerts configured

          ### üß™ UAT Validation
          Confirm the following were tested on UAT:
          - [ ] All new features work correctly
          - [ ] No regressions in existing functionality
          - [ ] Performance is acceptable
          - [ ] Security requirements met
          - [ ] User acceptance criteria satisfied

          ### üö® Production Deployment
          After merge:
          - [ ] Monitor deployment progress
          - [ ] Verify health checks pass
          - [ ] Check application logs for errors
          - [ ] Validate critical user flows
          - [ ] Monitor performance metrics
          - [ ] Be ready to rollback if issues arise

          ### üìù Notes
          - **CRITICAL:** This PR requires manual review and approval by senior team members
          - All CI checks must pass before merge
          - Production deployment requires environment approval
          - Deployment should be scheduled during low-traffic periods
          - Have rollback procedures ready

          ---
          **Auto-generated by:** \`.github/workflows/42-auto-promote-uat-to-main.yml\`
          **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}" \
            --label "auto-promotion,uat‚Üíproduction,requires-approval"

      - name: PR Already Exists
        if: steps.check-pr.outputs.pr_count != '0'
        run: |
          echo "::notice::An open PR from uat to main already exists. Skipping PR creation."
