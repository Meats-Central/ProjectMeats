name: "Copilot Setup Steps"

on:
  issues:
    types:
      - assigned
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  copilot-setup-steps:
    runs-on: ubuntu-latest

    
    container:
      image: ghcr.io/meats-central/projectmeats-backend:dev-latest
      
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    environment:
      name: copilot

    permissions:
      contents: read
      packages: read

   
    env:
      DJANGO_SETTINGS_MODULE: ${{ secrets.DEV_DJANGO_SETTINGS_MODULE }}
      SECRET_KEY: ${{ secrets.DEV_SECRET_KEY }}
      CORS_ALLOWED_ORIGINS: ${{ secrets.DEV_CORS_ALLOWED_ORIGINS }}
      DATABASE_URL: ${{ secrets.DEV_DATABASE_URL }}
      ALLOWED_HOSTS: ${{ secrets.DEV_ALLOWED_HOSTS }}
      LOG_LEVEL: ${{ secrets.LOG_LEVEL }}
      DB_ENGINE: ${{ secrets.DEV_DB_ENGINE }}
      DB_NAME: ${{ secrets.DEV_DB_NAME }}
      DB_USER: ${{ secrets.DEV_DB_USER }}
      DB_PASSWORD: ${{ secrets.DEV_DB_PASSWORD }}
      DB_HOST: ${{ secrets.DEV_DB_HOST }}
      DB_PORT: ${{ secrets.DEV_DB_PORT }}
      CORS_ALLOW_ALL_ORIGINS: ${{ secrets.CORS_ALLOW_ALL_ORIGINS }}
      SESSION_COOKIE_SECURE: ${{ secrets.SESSION_COOKIE_SECURE }}
      CSRF_COOKIE_SECURE: ${{ secrets.CSRF_COOKIE_SECURE }}
      OPENAI_API_KEY: ${{ secrets.DEV_OPENAI_API_KEY }}
      EMAIL_BACKEND: ${{ secrets.DEV_EMAIL_BACKEND }}
      EMAIL_HOST: ${{ secrets.DEV_EMAIL_HOST }}
      EMAIL_PORT: ${{ secrets.DEV_EMAIL_PORT }}
      EMAIL_USE_TLS: ${{ secrets.DEV_EMAIL_USE_TLS }}
      EMAIL_HOST_USER: ${{ secrets.DEV_EMAIL_HOST_USER }}
      EMAIL_HOST_PASSWORD: ${{ secrets.DEV_EMAIL_HOST_PASSWORD }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      
      - name: Verify Container Environment
        run: |
          echo "Copilot agent is running inside the deployed backend container."
          echo "Python version:"
          python --version || true
          echo
          echo "First 20 installed Python packages:"
          pip list | head -20 || true
          echo
          echo "Repository structure (top level):"
          ls -R . | head -100 || true
