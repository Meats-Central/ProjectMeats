name: Semantic PR Check

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
    branches:
      - main
      - uat
      - development

permissions:
  contents: read
  pull-requests: write

jobs:
  check-pr-title:
    name: Check PR Title Format
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR Title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          subjectPattern: ^(?![A-Z]).+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            didn't match the configured pattern. Please ensure that the subject
            doesn't start with an uppercase character.
          validateSingleCommit: false
          ignoreLabels: |
            skip-changelog
            dependencies

  branch-protection:
    name: Verify Branch Rules
    runs-on: ubuntu-latest
    steps:
      - name: Check Branch Flow
        run: |
          echo "Base: ${{ github.base_ref }}"
          echo "Head: ${{ github.head_ref }}"
          
          # Verify proper branch flow
          BASE="${{ github.base_ref }}"
          HEAD="${{ github.head_ref }}"
          
          # Feature branches should target development
          if [[ "$HEAD" =~ ^(feature|fix|hotfix|docs|refactor|chore)/ ]]; then
            if [ "$BASE" != "development" ]; then
              echo "❌ Feature branches must target 'development'"
              echo "   Current: $HEAD → $BASE"
              echo "   Required: $HEAD → development"
              exit 1
            fi
          fi
          
          # Development can only be promoted to UAT
          if [ "$HEAD" = "development" ] && [ "$BASE" != "uat" ]; then
            echo "❌ 'development' can only be merged to 'uat'"
            exit 1
          fi
          
          # UAT can only be promoted to main
          if [ "$HEAD" = "uat" ] && [ "$BASE" != "main" ]; then
            echo "❌ 'uat' can only be merged to 'main'"
            exit 1
          fi
          
          echo "✅ Branch flow is correct: $HEAD → $BASE"

  required-checks:
    name: Required Status Checks
    runs-on: ubuntu-latest
    needs: [check-pr-title, branch-protection]
    steps:
      - name: All Checks Passed
        run: |
          echo "✅ All required checks passed"
          echo "   - PR title is semantic"
          echo "   - Branch flow is correct"
