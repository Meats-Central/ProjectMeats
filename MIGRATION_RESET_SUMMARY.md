# Migration Reset Summary (Squash)

**Date**: December 6, 2025  
**Task**: Reset database migration history for `backend/apps/`  
**Status**: ✅ COMPLETED

## Overview

This document summarizes the migration reset (squash) performed on the ProjectMeats backend. All migration files in `backend/apps/` have been deleted and replaced with fresh `0001_initial.py` files, consolidating the migration history.

## What Was Changed

### 1. Deleted Migration Files (17 files)

#### apps/core/migrations/
- ❌ Deleted: `0002_userpreferences.py`
- ✅ Kept: `__init__.py`
- ✅ Created: `0001_initial.py` (fresh)

#### apps/tenants/migrations/
- ❌ Deleted 15 migration files:
  - `0002_alter_tenant_contact_phone_tenantinvitation_and_more.py`
  - `0003_tenant_logo.py`
  - `0004_add_schema_name_and_domain_model.py`
  - `0005_client_domain.py`
  - `0006_rename_tenants_ten_domain_6df599_idx_tenants_ten_domain_f3abe6_idx_and_more.py`
  - `0007_noop_index_rename.py`
  - `0008_stable_index_names.py`
  - `0009_fix_index_names.py`
  - `0010_schema_based_client_domain.py`
  - `0011_remove_schema_based_models.py`
  - `0011_tenant_schema_name.py`
  - `0012_purge_legacy_architecture.py`
  - `0013_tenant_schema_name.py`
  - `0014_tenant_schema_name.py`
  - `0015_alter_tenant_schema_name.py`
- ✅ Kept: `__init__.py`
- ✅ Created: `0001_initial.py` (fresh)

### 2. New Migration Files Created

#### apps/core/migrations/0001_initial.py
**Generated by**: Django 5.2.9 on 2025-12-06 18:20

**Operations**:
- Create model `Protein` (shared reference data for meat types)
- Create model `UserPreferences` (user UI customization settings)

**Dependencies**:
- Only depends on Django's auth app: `('auth', '__first__')`

**Models Created**:
```python
- Protein: name (unique)
- UserPreferences: user, theme, dashboard_layout, sidebar_collapsed, 
                   quick_menu_items, widget_preferences
```

#### apps/tenants/migrations/0001_initial.py
**Generated by**: Django 5.2.9 on 2025-12-06 18:20

**Operations**:
- Create model `Tenant` (main tenant organization)
- Create model `TenantDomain` (custom domain mapping)
- Create model `TenantInvitation` (invitation system)
- Create model `TenantUser` (tenant membership)
- Create 12 indexes for performance
- Create 1 constraint for data integrity

**Dependencies**:
- Only depends on Django's auth app: `('auth', '__first__')`

**Models Created**:
```python
- Tenant: id (UUID), name, slug, schema_name, domain, contact_email, 
          contact_phone, is_active, is_trial, trial_ends_at, created_at, 
          updated_at, created_by, settings, logo

- TenantDomain: id, tenant, domain, is_primary, is_active, created_at

- TenantInvitation: id, tenant, email, role, token, status, invited_by, 
                    accepted_by, created_at, accepted_at, expires_at

- TenantUser: id, tenant, user, role, is_active, created_at, updated_at
```

### 3. Updated Dependencies in Tenant Apps

Two tenant apps had dependencies on the old core migrations and were updated:

#### tenant_apps/suppliers/migrations/0001_initial.py
**Changed**: `("core", "0002_userpreferences")` → `("core", "0001_initial")`

#### tenant_apps/customers/migrations/0001_initial.py
**Changed**: `("core", "0002_userpreferences")` → `("core", "0001_initial")`

### 4. Updated .gitignore

Added pattern to exclude SQLite test databases:
```gitignore
*.sqlite3
```

## Verification Steps Completed

### ✅ 1. No Circular Dependencies
```bash
$ python manage.py makemigrations --check --dry-run
No changes detected
```

Django's migration loader confirmed:
- `core.0001_initial` depends only on `('auth', '__first__')`
- `tenants.0001_initial` depends only on `('auth', '__first__')`
- No circular dependencies between apps

### ✅ 2. Migration Structure
Each migrations folder contains exactly:
- `__init__.py`
- `0001_initial.py`

Total: 4 Python files in `backend/apps/*/migrations/`

### ✅ 3. Database Application Test
Successfully applied migrations on a fresh SQLite database:
```bash
$ python manage.py migrate
Operations to perform:
  Apply all migrations: accounts_receivables, admin, ai_assistant, auth, 
                       authtoken, bug_reports, carriers, cockpit, contacts, 
                       contenttypes, core, customers, invoices, plants, 
                       products, purchase_orders, sales_orders, sessions, 
                       suppliers, tenants
Running migrations:
  [... 46 migrations applied successfully ...]
  Applying core.0001_initial... OK
  Applying tenants.0001_initial... OK
```

### ✅ 4. Migration Status
```bash
$ python manage.py showmigrations core tenants
core
 [X] 0001_initial
tenants
 [X] 0001_initial
```

### ✅ 5. Database Tables Created
All expected tables were created:
- `core_protein`
- `core_userpreferences`
- `tenants_tenant`
- `tenants_tenant_user`
- `tenants_tenantdomain`
- `tenants_invitation`
- All related indexes and foreign key tables

### ✅ 6. Model Functionality
All models can be imported and queried:
```python
from apps.core.models import Protein, UserPreferences
from apps.tenants.models import Tenant, TenantUser, TenantDomain, TenantInvitation
# All imports successful, queries work correctly
```

## Architecture Notes

### Shared-Schema Multi-Tenancy
ProjectMeats uses a **shared-schema** multi-tenancy approach:
- All tenants share the same PostgreSQL schema
- Tenant isolation via `tenant_id` foreign keys on business models
- NO django-tenants schema-based isolation
- Custom `TenantMiddleware` for tenant resolution

### Migration Dependencies
The new migrations maintain clean dependency chains:
- `core` and `tenants` apps are independent
- Both only depend on Django's built-in `auth` app
- Tenant apps reference `core.0001_initial` for shared models

## What to Do Next

### For Development
1. Pull the latest changes from this branch
2. **Drop your local database** (existing migrations won't match)
3. Recreate the database: `python manage.py migrate`
4. Create a new superuser: `python manage.py createsuperuser`
5. Load any required seed data

### For Production/UAT
⚠️ **CRITICAL**: This is a breaking change requiring database rebuild

**Option 1: Fresh Start (Recommended for UAT)**
1. Backup existing data if needed
2. Drop the database
3. Recreate the database
4. Apply migrations: `python manage.py migrate`
5. Restore data from backup

**Option 2: Fake Migrations (If data must be preserved)**
1. Backup the database
2. Run: `python manage.py migrate --fake core 0001_initial`
3. Run: `python manage.py migrate --fake tenants 0001_initial`
4. Verify: `python manage.py showmigrations`

### For CI/CD
Update deployment workflows to handle migration reset:
- Ensure `python manage.py migrate --fake-initial` is used
- Or rebuild databases from scratch

## Files Changed

### Modified Files
- `backend/apps/core/migrations/0001_initial.py` (new)
- `backend/apps/tenants/migrations/0001_initial.py` (new)
- `backend/tenant_apps/suppliers/migrations/0001_initial.py` (dependency update)
- `backend/tenant_apps/customers/migrations/0001_initial.py` (dependency update)
- `backend/.gitignore` (added `*.sqlite3`)

### Deleted Files
- 17 migration files from `backend/apps/core/migrations/` and `backend/apps/tenants/migrations/`

## Testing Checklist

Before deploying to production, verify:

- [ ] All models can be imported without errors
- [ ] Fresh database migrations apply cleanly
- [ ] No circular dependency warnings
- [ ] Tenant isolation still works correctly
- [ ] All tenant app models can reference core models
- [ ] Authentication and user models work correctly
- [ ] Existing tests pass with new migration structure
- [ ] CI/CD pipelines updated for migration reset

## Questions?

If you encounter issues:
1. Check that your database is fresh (or migrations are faked)
2. Verify no stale `.pyc` files: `find . -name "*.pyc" -delete`
3. Check migration status: `python manage.py showmigrations`
4. Refer to `DATABASE_MIGRATION_GUIDE.md` for detailed instructions

---

**Migration Reset Completed**: December 6, 2025  
**Django Version**: 5.2.9  
**Database**: PostgreSQL (production), SQLite (development)  
**Multi-Tenancy**: Shared Schema (NOT django-tenants)
