# Use Node 20 to match Storybook engines and avoid EBADENGINE warnings
FROM node:20-alpine AS build
WORKDIR /app/frontend

# 1) Install deps
# Make sure frontend/package*.json is copied correctly from the root
COPY frontend/package*.json ./  # Copy package.json to /app/frontend
RUN npm ci  # Install dependencies

# 2) Copy sources INCLUDING the shared/ folder your TS imports use
COPY frontend ./  # Copy the frontend source files to /app/frontend
COPY shared ./shared  # Copy the shared folder

# 3) Build from inside frontend
WORKDIR /app/frontend
# Optional: ensure CRA treats this as CI (non-interactive)
ENV CI=true
RUN npm run build  # Build the frontend app

# Runtime stage
FROM nginx:alpine
COPY deploy/nginx/frontend.conf /etc/nginx/conf.d/default.conf  # Use your custom nginx config
COPY --from=build /app/frontend/build /usr/share/nginx/html  # Copy the build output to nginx
EXPOSE 80
HEALTHCHECK --interval=30s --timeout=3s CMD wget -qO- http://127.0.0.1/ || exit 1
