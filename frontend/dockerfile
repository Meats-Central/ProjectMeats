# # Use Node 20 to match Storybook engines and avoid EBADENGINE warnings
# FROM node:20-alpine AS build
# WORKDIR /app

# # 1) Install deps
# COPY frontend/package*.json ./frontend/
# RUN cd frontend && npm ci

# # 2) Copy sources INCLUDING the shared/ folder your TS imports use
# COPY frontend ./frontend
# COPY shared  ./shared

# # 3) Build from inside frontend
# WORKDIR /app/frontend
# # Optional: ensure CRA treats this as CI (non-interactive)
# ENV CI=true
# RUN npm run build

# # Runtime
# FROM nginx:alpine
# COPY deploy/nginx/frontend.conf /etc/nginx/conf.d/default.conf
# COPY --from=build /app/frontend/build /usr/share/nginx/html
# EXPOSE 80
# HEALTHCHECK --interval=30s --timeout=3s CMD wget -qO- http://127.0.0.1/ || exit 1


# Use Node 20 for the build stage
FROM node:25-alpine AS build
WORKDIR /project

# 1) Install deps
COPY frontend/package*.json ./frontend/
RUN cd frontend && npm install --legacy-peer-deps

# 2) Copy sources
COPY frontend ./frontend
COPY shared  ./shared

# 3) Build inside frontend
WORKDIR /project/frontend
ENV CI=true
RUN npm run build

# Runtime with nginx and npm installed
FROM nginx:alpine
RUN apk add --no-cache nodejs npm bash  # Install npm, nodejs, and bash here

# Copy nginx configuration
COPY deploy/nginx/frontend.conf /etc/nginx/conf.d/default.conf

# Copy the built files from the build stage
COPY --from=build /project/frontend/build /usr/share/nginx/html

# Create entrypoint script with nginx validation
# This ensures nginx configuration is valid before starting the server
RUN cat > /docker-entrypoint.sh <<'EOF'
#!/bin/bash
set -e

echo "=== Validating nginx configuration ==="
# Test nginx configuration before starting
if nginx -t -c /etc/nginx/nginx.conf; then
    echo "✓ Nginx configuration is valid"
else
    echo "✗ Nginx configuration validation failed!"
    echo ""
    echo "Configuration files:"
    echo "===================="
    echo "Main config: /etc/nginx/nginx.conf"
    echo "Default config: /etc/nginx/conf.d/default.conf"
    echo ""
    echo "Content of /etc/nginx/conf.d/default.conf:"
    cat /etc/nginx/conf.d/default.conf
    exit 1
fi

echo "=== Starting nginx ==="
exec nginx -g 'daemon off;'
EOF

RUN chmod +x /docker-entrypoint.sh

EXPOSE 80
HEALTHCHECK --interval=30s --timeout=3s CMD wget -qO- http://127.0.0.1/ || exit 1

# Use our custom entrypoint that validates config before starting
ENTRYPOINT ["/docker-entrypoint.sh"]
