# # Use Node 20 to match Storybook engines and avoid EBADENGINE warnings
# FROM node:20-alpine AS build
# WORKDIR /app

# # 1) Install deps
# COPY frontend/package*.json ./frontend/
# RUN cd frontend && npm ci

# # 2) Copy sources INCLUDING the shared/ folder your TS imports use
# COPY frontend ./frontend
# COPY shared  ./shared

# # 3) Build from inside frontend
# WORKDIR /app/frontend
# # Optional: ensure CRA treats this as CI (non-interactive)
# ENV CI=true
# RUN npm run build

# # Runtime
# FROM nginx:alpine
# COPY deploy/nginx/frontend.conf /etc/nginx/conf.d/default.conf
# COPY --from=build /app/frontend/build /usr/share/nginx/html
# EXPOSE 80
# HEALTHCHECK --interval=30s --timeout=3s CMD wget -qO- http://127.0.0.1/ || exit 1


# Use Node 20 to match Storybook engines and avoid EBADENGINE warnings
FROM node:20-alpine AS build

# Set working directory inside the container
WORKDIR /app

# 1) Install dependencies
COPY frontend/package*.json ./frontend/
RUN cd frontend && npm ci

# 2) Copy sources INCLUDING the shared/ folder your TS imports use
COPY frontend ./frontend
COPY shared ./shared

# 3) Build from inside frontend
WORKDIR /app/frontend

# Optional: ensure CRA treats this as CI (non-interactive)
ENV CI=true
RUN npm run build

# Runtime - Start from nginx to serve the frontend
FROM nginx:alpine

# Copy the custom Nginx config into the container
COPY deploy/nginx/frontend.conf /etc/nginx/conf.d/default.conf

# Copy the build artifacts from the build stage to Nginx
COPY --from=build /app/frontend/build /usr/share/nginx/html

# Add .env file to the container (generated during build process)
COPY .env /app/.env

# Expose port 80
EXPOSE 80

# Add health check for the container
HEALTHCHECK --interval=30s --timeout=3s CMD wget -qO- http://127.0.0.1/ || exit 1

# Optionally, you can define environment variables here, or it could be passed at runtime
ENV ENV_FILE=/app/.env

# (Optional) If you're using nginx to proxy to a backend, you can define the backend URL as environment variable
ENV BACKEND_URL="http://backend:8000"
