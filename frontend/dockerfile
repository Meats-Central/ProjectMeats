# # Use Node 20 to match Storybook engines and avoid EBADENGINE warnings
# FROM node:20-alpine AS build
# WORKDIR /app

# # 1) Install deps
# COPY frontend/package*.json ./frontend/
# RUN cd frontend && npm ci

# # 2) Copy sources INCLUDING the shared/ folder your TS imports use
# COPY frontend ./frontend
# COPY shared  ./shared

# # 3) Build from inside frontend
# WORKDIR /app/frontend
# # Optional: ensure CRA treats this as CI (non-interactive)
# ENV CI=true
# RUN npm run build

# # Runtime
# FROM nginx:alpine
# COPY deploy/nginx/frontend.conf /etc/nginx/conf.d/default.conf
# COPY --from=build /app/frontend/build /usr/share/nginx/html
# EXPOSE 80
# HEALTHCHECK --interval=30s --timeout=3s CMD wget -qO- http://127.0.0.1/ || exit 1


# --- Build stage ---
FROM node:20-alpine AS build
WORKDIR /app

# Build args for all React envs you need
ARG REACT_APP_API_BASE_URL
ARG REACT_APP_ENVIRONMENT
ARG REACT_APP_AI_ASSISTANT_ENABLED
ARG REACT_APP_ENABLE_DOCUMENT_UPLOAD
ARG REACT_APP_ENABLE_CHAT_EXPORT
ARG REACT_APP_MAX_FILE_SIZE
ARG REACT_APP_SUPPORTED_FILE_TYPES
ARG REACT_APP_ENABLE_DEBUG
ARG REACT_APP_ENABLE_DEVTOOLS
ARG NODE_ENV

# Export them so CRA sees them during build
ENV REACT_APP_API_BASE_URL=${REACT_APP_API_BASE_URL}
ENV REACT_APP_ENVIRONMENT=${REACT_APP_ENVIRONMENT}
ENV REACT_APP_AI_ASSISTANT_ENABLED=${REACT_APP_AI_ASSISTANT_ENABLED}
ENV REACT_APP_ENABLE_DOCUMENT_UPLOAD=${REACT_APP_ENABLE_DOCUMENT_UPLOAD}
ENV REACT_APP_ENABLE_CHAT_EXPORT=${REACT_APP_ENABLE_CHAT_EXPORT}
ENV REACT_APP_MAX_FILE_SIZE=${REACT_APP_MAX_FILE_SIZE}
ENV REACT_APP_SUPPORTED_FILE_TYPES=${REACT_APP_SUPPORTED_FILE_TYPES}
ENV REACT_APP_ENABLE_DEBUG=${REACT_APP_ENABLE_DEBUG}
ENV REACT_APP_ENABLE_DEVTOOLS=${REACT_APP_ENABLE_DEVTOOLS}
ENV NODE_ENV=${NODE_ENV}

# 1) deps
COPY frontend/package*.json ./frontend/
RUN cd frontend && npm ci

# 2) sources
COPY frontend ./frontend
COPY shared  ./shared

# 3) build
WORKDIR /app/frontend
ENV CI=true
RUN npm run build

# --- Runtime stage ---
FROM nginx:alpine
COPY deploy/nginx/frontend.conf /etc/nginx/conf.d/default.conf
COPY --from=build /app/frontend/build /usr/share/nginx/html
EXPOSE 80
HEALTHCHECK --interval=30s --timeout=3s CMD wget -qO- http://127.0.0.1/ || exit 1
