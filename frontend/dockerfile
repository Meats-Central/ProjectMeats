# Use Node 20 for Vite build
FROM node:20-alpine AS build
WORKDIR /project

# Install dependencies
COPY frontend/package*.json ./frontend/
RUN cd frontend && npm install --legacy-peer-deps

# Copy source files
COPY frontend ./frontend
COPY shared  ./shared

# Build with Vite
WORKDIR /project/frontend
ENV NODE_ENV=production
RUN npm run build

# Runtime with nginx
FROM nginx:alpine
RUN apk add --no-cache bash

# Copy nginx configuration
COPY deploy/nginx/frontend.conf /etc/nginx/conf.d/default.conf

# Copy the built files from the build stage
COPY --from=build /project/frontend/build /usr/share/nginx/html

# Copy runtime env-config.js to public directory
COPY frontend/public/env-config.js /usr/share/nginx/html/env-config.js

# Create entrypoint script with nginx validation
RUN cat > /docker-entrypoint.sh <<'EOF'
#!/bin/bash
set -e

echo "=== Validating nginx configuration ==="
if nginx -t -c /etc/nginx/nginx.conf; then
    echo "✓ Nginx configuration is valid"
else
    echo "✗ Nginx configuration validation failed!"
    exit 1
fi

echo "=== Starting nginx ==="
exec nginx -g 'daemon off;'
EOF

RUN chmod +x /docker-entrypoint.sh

EXPOSE 80
HEALTHCHECK --interval=30s --timeout=3s CMD wget -qO- http://127.0.0.1/ || exit 1

ENTRYPOINT ["/docker-entrypoint.sh"]

